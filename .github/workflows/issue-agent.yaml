name: 'Agent: Cognitive Loop'

on:
  issues:
    types: [labeled, commented, reopened]
  pull_request:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cognitive-loop:
    if: >
      (
        github.event.label.name == 'jules' ||
        contains(github.event.comment.body, '@jules') ||
        (github.event.action == 'reopened' && contains(github.event.issue.labels.*.name, 'jules'))
      ) &&
      github.actor != 'dependabot[bot]' &&
      github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # Step 1: Plan and Execute
      # The agent (Jules) first creates a plan, posts it as a comment,
      # and then executes the plan by creating a branch and committing code.
      - name: Plan and Execute
        id: jules
        uses: google-labs-code/jules-invoke@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          # Note: The original request specified 'validate.yaml', but the Jules
          # invocation is in this file ('agent-jules.yml'). This change corrects
          # the 'Unexpected input' error and enforces the beta branch strategy.
          starting_branch: 'beta'

      # Step 2: Validation
      # This step runs after the agent has committed code. It checks for
      # code quality and syntax errors. If this step fails, the agent
      # is expected to fix the issues in the next run (self-correction).
      - name: Checkout agent's branch
        if: success() && steps.jules.outputs.branch_name != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.jules.outputs.branch_name }}

      - name: Set up Python
        if: success() && steps.jules.outputs.branch_name != ''
        uses: actions/setup-python@v6
        with:
          python-version-file: '.python-version'

      - name: Set up uv
        if: success() && steps.jules.outputs.branch_name != ''
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
