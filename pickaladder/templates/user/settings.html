{% extends "layout.html" %}
{% block title %}Settings{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
<style>
    .form-card {
        max-width: 600px;
        margin: 2rem auto;
    }

    .section-title {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        margin-top: 2rem;
    }

    .section-title:first-of-type {
        margin-top: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-card card p-4">
    <h2 class="mb-4">⚙️ Settings</h2>

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Section 1: Public Profile -->
        <h4 class="section-title">Public Profile</h4>

        <div class="text-center mb-4">
            <div class="profile-picture-container avatar-xl mx-auto mb-3">
                <img id="settings-profile-img" src="{{ user | avatar_url }}" alt="Profile Picture"
                    class="profile-picture">
            </div>
            <div class="form-group">
                {{ form.profile_picture(class="form-control", id="profile-pic-input", accept="image/*",
                style="display:none;") }}
                <button type="button" class="btn btn-sm btn-outline-primary"
                    onclick="document.getElementById('profile-pic-input').click();">Change Photo</button>
            </div>
        </div>

        <div class="form-group mb-3">
            {{ form.name.label(class="form-label") }}
            {{ form.name(class="form-control") }}
            {% for error in form.name.errors %}
            <span class="text-danger small">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group mb-3">
            {{ form.username.label(class="form-label") }}
            {{ form.username(class="form-control") }}
            {% for error in form.username.errors %}
            <span class="text-danger small">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group mb-3">
            {{ form.email.label(class="form-label") }}
            {{ form.email(class="form-control") }}
            {% for error in form.email.errors %}
            <span class="text-danger small">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.dupr_id.label(class="form-label") }}
                {{ form.dupr_id(class="form-control") }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.dupr_rating.label(class="form-label") }}
                {{ form.dupr_rating(class="form-control", step="0.01") }}
            </div>
        </div>

        <!-- Section 2: App Preferences -->
        <h4 class="section-title">App Preferences</h4>
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
                <label class="form-label mb-0">Enable Dark Mode</label>
                <p class="text-muted small mb-0">Switch to a darker theme for the interface.</p>
            </div>
            <label class="switch">
                {{ form.dark_mode() }}
                <span class="slider round"></span>
            </label>
        </div>

        <!-- Section 3: Security -->
        <h4 class="section-title">Security</h4>
        <div class="mb-4">
            <a href="{{ url_for('auth.change_password') }}" class="btn btn-outline-secondary">Change Password</a>
        </div>

        <div class="d-grid gap-2">
            {{ form.submit(class="btn btn-volt w-100") }}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const profilePictureInput = document.getElementById('profile-pic-input');
        const profilePictureImg = document.getElementById('settings-profile-img');

        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        profilePictureImg.src = e.target.result;
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
    });
</script>
{% endblock %}