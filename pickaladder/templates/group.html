{% extends "layout.html" %}
{% block title %}{{ group.name }}{% endblock %}
{% block content %}
<div class="page-header group-header-content">
    <img src="{{ group.profilePictureUrl if group.profilePictureUrl else (url_for('static', filename='uploads/' + group.profile_picture_path) if group.profile_picture_path else url_for('static', filename='user_icon.png')) }}" alt="Group Picture" class="group-profile-picture">
    <div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <h1>{{ group.name }}</h1>
            {% if is_member %}
                <a href="{{ url_for('match.record_match', group_id=group.id) }}" class="btn">Record a Match</a>
            {% endif %}
            {% if group.ownerRef.id == current_user_id %}
                <a href="{{ url_for('group.edit_group', group_id=group.id) }}" class="btn">Edit Group</a>
            {% endif %}
        </div>
        <p style="margin-bottom: 5px;">Owned by: <a href="{{ url_for('user.view_user', user_id=group['ownerRef'].id) }}">{{ owner.username }}</a></p>
        {% if group.location %}
            <p style="margin-bottom: 5px;"><strong>Location:</strong> {{ group.location }}</p>
        {% endif %}
        <p style="color: #666;">{{ group.description or 'No description provided.' }}</p>
    </div>
</div>

<div class="grid-container">
    <div class="card">
        <h3>Members</h3>
        <div class="table-container">
            <table class="table responsive-table">
                <tbody>
                    {% for member in members %}
                    <tr class="clickable-row" data-href="{{ url_for('user.view_user', user_id=member.id) }}">
                        <td data-label="Avatar">
                            <img src="{{ member.profilePictureUrl or url_for('static', filename='user_icon.png') }}"
                                alt="Profile Picture" class="profile-picture-thumbnail">
                        </td>
                        <td data-label="Username">{{ member.username }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_member and pending_members %}
        <h3 style="margin-top: 20px;">Pending Members</h3>
        <div class="table-container">
            <table class="table responsive-table">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        {% if group.ownerRef.id == current_user_id %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for invite in pending_members %}
                    <tr>
                        <td data-label="Avatar">
                            <img src="{{ invite.profilePictureUrl or url_for('static', filename='user_icon.png') }}"
                                 alt="Profile Picture" class="profile-picture-thumbnail">
                        </td>
                        <td data-label="Name">{{ invite.username or invite.name }}</td>
                        <td data-label="Email">{{ invite.email }}</td>
                        <td data-label="Status">
                            {% if invite.status == 'failed' %}
                                <span class="badge danger" title="{{ invite.last_error }}">Failed</span>
                            {% elif invite.status == 'sending' %}
                                <span class="badge warning">Sending...</span>
                            {% elif invite.status == 'sent' %}
                                <span class="badge success">Sent</span>
                            {% else %}
                                <span class="badge">{{ invite.status or 'Pending' }}</span>
                            {% endif %}
                        </td>
                        {% if group.ownerRef.id == current_user_id %}
                        <td data-label="Actions">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <form method="post" action="{{ url_for('group.resend_invite', token=invite.token) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <!-- Simple inline update for email if failed -->
                                    {% if invite.status == 'failed' %}
                                    <div class="input-group" style="margin-bottom: 5px;">
                                        <input type="email" name="email" value="{{ invite.email }}" required class="form-control" style="padding: 5px; width: 150px;">
                                    </div>
                                    {% endif %}
                                    <button type="submit" class="btn small">
                                        {% if invite.status == 'failed' %}Retry{% else %}Resend{% endif %}
                                    </button>
                                </form>
                                <form method="post" action="{{ url_for('group.delete_invite', token=invite.token) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger small" onclick="return confirm('Cancel this invitation?')">Cancel</button>
                                </form>
                            </div>
                            {% if invite.status == 'failed' and invite.last_error %}
                                <div style="font-size: 0.8em; color: red; margin-top: 5px; max-width: 200px; word-wrap: break-word;">
                                    {{ invite.last_error }}
                                </div>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if group.ownerRef.id == current_user_id %}
        <h3 style="margin-top: 20px;">Invite Friends</h3>
        <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.friend.label }}
                {{ form.friend(class="form-control") }}
            </div>
            <input type="submit" value="Invite Friend" class="btn">
        </form>

        <h3 style="margin-top: 20px;">Invite by Email</h3>
        <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
            {{ invite_email_form.hidden_tag() }}
            <div class="form-group">
                {{ invite_email_form.name.label }}
                {{ invite_email_form.name(class="form-control") }}
            </div>
            <div class="form-group">
                {{ invite_email_form.email.label }}
                {{ invite_email_form.email(class="form-control") }}
            </div>
            <input type="submit" value="Send Invite" class="btn">
        </form>

        <h3 style="margin-top: 20px;">Danger Zone</h3>
        <form method="post" action="{{ url_for('group.delete_group', group_id=group.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="submit" value="Delete Group" class="btn btn-danger"
                onclick="return confirm('Are you sure you want to permanently delete this group? This action cannot be undone.')">
        </form>
        {% endif %}
    </div>

    <div class="card">
        <h3>Rivalry Check</h3>
        <div class="form-group">
            <label for="player1-select">Player 1</label>
            <select id="player1-select" class="form-control">
                <option value="">Select a player</option>
                {% for member in members %}
                    <option value="{{ member.id }}">{{ member.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="player2-select">Player 2</label>
            <select id="player2-select" class="form-control">
                <option value="">Select a player</option>
                {% for member in members %}
                    <option value="{{ member.id }}">{{ member.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="head-to-head-stats" style="margin-top: 15px;">
            <!-- Stats will be loaded here -->
        </div>
    </div>

    <div class="card">
        <h3>Group Leaderboard</h3>
        <p>A live ranking of all group members.</p>
        <div class="leaderboard-container">
            <div class="leaderboard-header">
                <div class="leaderboard-cell">Rank</div>
                <div class="leaderboard-cell">Player</div>
                <div class="leaderboard-cell">Avg. Score</div>
                <div class="leaderboard-cell">Form</div>
                <div class="leaderboard-cell">Games</div>
            </div>
            <div class="leaderboard-body">
                {% for player in leaderboard %}
                <div class="leaderboard-row {{ 'highlight-user' if player.id == g.user['uid'] else '' }}">
                    <div class="leaderboard-cell" data-label="Rank">
                        <div class="player-rank">
                            <span>
                                {% if loop.index == 1 %}ü•á
                                {% elif loop.index == 2 %}ü•à
                                {% elif loop.index == 3 %}ü•â
                                {% else %}{{ loop.index }}{% endif %}
                            </span>
                            <span class="rank-trend">
                                {% if player.rank_change is number and player.rank_change > 0 %}
                                    <span class="trend-up">‚ñ≤</span>
                                {% elif player.rank_change is number and player.rank_change < 0 %}
                                    <span class="trend-down">‚ñº</span>
                                {% elif player.rank_change == 'new' %}
                                    <span class="trend-new">‚óè</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="leaderboard-cell" data-label="Player">
                        <a href="{{ url_for('user.view_user', user_id=player.id) }}" class="player-link">
                            <img src="{{ player.profilePictureUrl or url_for('static', filename='user_icon.png') }}" alt="{{ player.name }}" class="profile-picture-thumbnail">
                            <span class="player-name">{{ player.name }}</span>
                        </a>
                    </div>
                    <div class="leaderboard-cell" data-label="Avg. Score">{{ "%.2f"|format(player.avg_score|float) }}</div>
                    <div class="leaderboard-cell" data-label="Form">
                        <div class="form-dots">
                            {% for result in player.form %}
                                <span class="form-dot {{ result }}"></span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="leaderboard-cell" data-label="Games">{{ player.games_played }}</div>
                </div>
                {% else %}
                <div class="leaderboard-empty">
                    <p>No matches have been played between members of this group yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="leaderboard-trend-link">
            <a href="{{ url_for('group.view_leaderboard_trend', group_id=group.id) }}">View Leaderboard Trend Chart</a>
        </div>
    </div>

    {% if recent_matches %}
    <div class="card">
        <h3>Recent Matches</h3>
        <div class="table-container">
            <table class="table responsive-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Player 1</th>
                        <th>Player 2</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in recent_matches %}
                    <tr>
                        <td data-label="Date">{{ match.matchDate.strftime('%Y-%m-%d') if match.matchDate else 'N/A' }}</td>
                        <td data-label="Player 1">{{ match.player1.username }}</td>
                        <td data-label="Player 2">{{ match.player2.username }}</td>
                        <td data-label="Score">{{ match.player1Score }} - {{ match.player2Score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const player1Select = document.getElementById('player1-select');
    const player2Select = document.getElementById('player2-select');
    const statsContainer = document.getElementById('head-to-head-stats');

    function fetchAndDisplayStats() {
        const player1Id = player1Select.value;
        const player2Id = player2Select.value;

        // Clear stats if players are the same or one is not selected
        if (player1Id === player2Id || !player1Id || !player2Id) {
            statsContainer.innerHTML = '';
            return;
        }

        statsContainer.innerHTML = '<p>Loading...</p>';

        const url = `/group/{{ group.id }}/stats/head_to_head?player1_id=${player1Id}&player2_id=${player2Id}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const player1Name = player1Select.options[player1Select.selectedIndex].text;
                const player2Name = player2Select.options[player2Select.selectedIndex].text;

                if (data.total_matches === 0) {
                    statsContainer.innerHTML = '<p>These players haven\\'t played any matches together yet.</p>';
                    return;
                }

                const [p1H2HWins, p2H2HWins] = data.head_to_head_record.split('-').map(Number);
                const [partnerWins, partnerLosses] = data.partnership_record.split('-').map(Number);

                const totalH2H = p1H2HWins + p2H2HWins;
                const p1H2HPercent = totalH2H > 0 ? (p1H2HWins / totalH2H) * 100 : 50;
                const p2H2HPercent = totalH2H > 0 ? (p2H2HWins / totalH2H) * 100 : 50;

                const totalPartnerGames = partnerWins + partnerLosses;
                const partnerWinRate = totalPartnerGames > 0 ? (partnerWins / totalPartnerGames) * 100 : 0;

                let leaderMessage = '';
                if (p1H2HWins > p2H2HWins) {
                    leaderMessage = `${player1Name} leads the rivalry.`;
                } else if (p2H2HWins > p1H2HWins) {
                    leaderMessage = `${player2Name} leads the rivalry.`;
                } else if (totalH2H > 0) {
                    leaderMessage = 'The rivalry is tied.';
                }

                const statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h5>Head-to-Head</h5>
                            <div class="h2h-scores">
                                <span class="player-name">${player1Name}</span>
                                <span class="score">${p1H2HWins} - ${p2H2HWins}</span>
                                <span class="player-name">${player2Name}</span>
                            </div>
                            <div class="rivalry-bar-container">
                                <div class="rivalry-bar player1" style="width: ${p1H2HPercent}%;" title="${player1Name}: ${p1H2HWins} wins"></div>
                                <div class="rivalry-bar player2" style="width: ${p2H2HPercent}%;" title="${player2Name}: ${p2H2HWins} wins"></div>
                            </div>
                            <p class="leader-message">${leaderMessage}</p>
                        </div>
                        <div class="stat-card">
                            <h5>As Partners</h5>
                            <p><strong>Record:</strong> ${partnerWins}W - ${partnerLosses}L</p>
                            <p><strong>Win Rate:</strong> ${partnerWinRate.toFixed(1)}%</p>
                        </div>
                        <div class="stat-card">
                            <h5>Point Differential</h5>
                            <p>Avg. <strong>${data.avg_point_differential > 0 ? '+' : ''}${data.avg_point_differential}</strong> points for ${player1Name}</p>
                        </div>
                    </div>
                `;

                statsContainer.innerHTML = statsHtml;
            })
            .catch(error => {
                statsContainer.innerHTML = '<p class="text-danger">Error loading stats.</p>';
                console.error('Error fetching head-to-head stats:', error);
            });
    }

    player1Select.addEventListener('change', fetchAndDisplayStats);
    player2Select.addEventListener('change', fetchAndDisplayStats);
});
</script>
<style>
    .stats-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .stat-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; text-align: center; }
    .stat-card h5 { margin-top: 0; margin-bottom: 10px; }
    .h2h-scores { display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; margin-bottom: 10px; }
    .h2h-scores .player-name { font-size: 0.8em; }
    .h2h-scores .score { font-weight: bold; }
    .rivalry-bar-container { display: flex; height: 20px; border-radius: 5px; overflow: hidden; background-color: #f0f0f0; margin-bottom: 10px; }
    .rivalry-bar { transition: width 0.3s ease-in-out; }
    .rivalry-bar.player1 { background-color: #4CAF50; }
    .rivalry-bar.player2 { background-color: #F44336; }
    .leader-message { font-style: italic; color: #555; }
</style>
{% endblock %}
