{% extends "layout.html" %}
{% block title %}{{ group.name }}{% endblock %}
{% block content %}
<div class="card hero-stats-card">
    {% if group.ownerRef.id == current_user_id %}
    <a href="{{ url_for('group.edit_group', group_id=group.id) }}" title="Group Settings" class="btn-edit-gear"
        data-testid="group-settings-btn">‚öôÔ∏è</a>
    {% endif %}

    <div class="hero-left-panel">
        <div class="profile-picture-container avatar-xl">
            <img src="{{ group.profilePictureUrl if group.profilePictureUrl else (url_for('static', filename='uploads/' + group.profile_picture_path) if group.profile_picture_path else url_for('static', filename='user_icon.png')) }}"
                alt="Group Picture" class="profile-picture">
        </div>
    </div>

    <div class="hero-middle-panel text-center">
        <h1>{{ group.name }}</h1>
        <div class="group-meta-info">
            <p>
                Owned by: <a href="{{ url_for('user.view_user', user_id=group['ownerRef'].id) }}">{{ owner.username }}</a>
                {% if group.location %}
                ‚Ä¢ Location: {{ group.location }}
                {% endif %}
            </p>
        </div>
        <p class="group-description">{{ group.description or 'No description provided.' }}</p>
    </div>

    <div class="hero-right-panel">
        {% if is_member %}
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-auto" data-toggle="modal"
                data-target="#shareGroupModal">
                <i class="fas fa-share-alt"></i> Share
            </button>
            <a href="{{ url_for('match.record_match', group_id=group.id) }}" class="btn btn-volt w-auto">Record a Match</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="grid-container">

    <div>
        <div class="card">
            <h3>Group Leaderboard</h3>
            <p>A live ranking of all group members.</p>

            {% if recent_matches %}
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'players')">Players</button>
                    <button class="tab-button" onclick="openTab(event, 'teams')">Teams</button>
                </div>

                <div id="players" class="tab-content" style="display: block;">
                    <div class="table-container">
                        <table class="table table-standard responsive-table">
                            <thead>
                                <tr>
                                    <th class="text-center">Rank</th>
                                    <th class="text-left">Player</th>
                                    <th class="text-right">Form</th>
                                    <th class="text-right">Avg Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in leaderboard %}
                                <tr class="{{ 'bg-primary-subtle' if player.id == g.user['uid'] else '' }}">
                                    <td data-label="Rank" class="rank-cell text-center {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% endif %}">
                                        <span class="mobile-rank-badge">
                                            {% if loop.index == 1 %}ü•á
                                            {% elif loop.index == 2 %}ü•à
                                            {% elif loop.index == 3 %}ü•â
                                            {% else %}#{{ loop.index }}{% endif %}
                                        </span>
                                        <span class="rank-trend">
                                            {% if player.rank_change is number and player.rank_change > 0 %}
                                            <span class="trend-up">‚ñ≤</span>
                                            {% elif player.rank_change is number and player.rank_change < 0 %} <span
                                                class="trend-down">‚ñº</span>
                                            {% elif player.rank_change == 'new' %}
                                            <span class="trend-new">‚óè</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td data-label="Player" class="text-left">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <a href="{{ url_for('user.view_user', user_id=player.id) }}"
                                                class="player-link-compact">
                                                <img src="{{ player | avatar_url }}" alt="{{ player | display_name }}"
                                                    class="avatar avatar-sm"
                                                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                                <span class="player-name-compact">{{ player | display_name }}</span>
                                                {% if player.is_on_fire %}
                                                <span title="{{ player.streak }} Game Streak!">üî•</span>
                                                {% endif %}
                                            </a>
                                            {% if player.id == g.user['uid'] %}
                                            <button class="btn btn-volt small share-stats-btn"
                                                style="width: auto; margin-left: 10px; padding: 4px 8px; font-size: 0.7rem;"
                                                onclick="openBragCard('{{ player.id }}', '{{ player | display_name }}', '{{ player | avatar_url }}', '{{ loop.index }}', '{{ player.streak }}')">
                                                Share Stats
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td data-label="Form" class="text-right">
                                        <div class="form-dots-compact">
                                            {% for result in player.form %}
                                            <span class="form-dot-compact {{ result }}"></span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td data-label="Avg Score" class="text-right font-weight-bold">
                                        {{ "%.2f"|format(player.avg_score|float) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="teams" class="tab-content" style="display: none;">
                    <div class="table-container">
                        <table class="table table-standard responsive-table">
                            <thead>
                                <tr>
                                    <th class="text-center">Rank</th>
                                    <th class="text-left">Team</th>
                                    <th class="text-right">W-L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in team_leaderboard %}
                                <tr>
                                    <td data-label="Rank" class="rank-cell text-center {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% endif %}">
                                        <span class="mobile-rank-badge">
                                            {% if loop.index == 1 %}ü•á
                                            {% elif loop.index == 2 %}ü•à
                                            {% elif loop.index == 3 %}ü•â
                                            {% else %}#{{ loop.index }}{% endif %}
                                        </span>
                                    </td>
                                    <td data-label="Team" class="text-left">
                                        <div class="team-members-compact">
                                            {% for member in entry.team.member_details %}
                                            <img src="{{ member | avatar_url }}" alt="{{ member | display_name }}"
                                                class="avatar avatar-sm"
                                                onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                            {% endfor %}
                                            <span class="team-name-compact">{{ entry.team.name }}</span>
                                        </div>
                                    </td>
                                    <td data-label="W-L" class="text-right font-weight-bold">
                                        {{ entry.stats.wins }}-{{ entry.stats.losses }}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No teams formed yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card card-notification text-center">
                <p class="mb-0">No matches recorded yet. Be the first to play!</p>
            </div>
            {% endif %}

            <div class="leaderboard-trend-link">
                <a href="{{ url_for('group.view_leaderboard_trend', group_id=group.id) }}">View Leaderboard Trend
                    Chart</a>
            </div>
        </div>
    </div>

    <div>
        {% if best_buds %}
        <div class="card best-buds-card">
            <h3>üëØ Best Buds</h3>
            <div class="best-buds-container">
                {% for member in best_buds.member_details %}
                <img src="{{ member | avatar_url }}" alt="{{ member.name or member.username }}" class="avatar avatar-sm"
                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                {% if not loop.last %}<span class="plus-sign">+</span>{% endif %}
                {% endfor %}
            </div>
            <p>
                {% if best_buds.name %}
                {{ best_buds.name }}
                {% else %}
                {{ best_buds.member_details[0].name or best_buds.member_details[0].username }} & {{
                best_buds.member_details[1].name or best_buds.member_details[1].username }}
                {% endif %}: {{ best_buds.stats.get('wins', 0) }} Wins Together!
            </p>
        </div>
        {% endif %}


        {% if recent_matches %}
        <div class="card">
            <h3>Recent Matches</h3>
            <div class="match-history-feed">
                {% for match in recent_matches %}
                <div class="match-history-row">
                    <span class="match-date-compact text-muted">{{ match.matchDate.strftime('%m/%d') if match.matchDate
                        else 'N/A' }}</span>

                    <div class="match-main-content">
                        {% set p1_score = match.player1Score|default(0) %}
                        {% set p2_score = match.player2Score|default(0) %}
                        {% set p1_win = p1_score > p2_score %}
                        {% set p2_win = p2_score > p1_score %}

                        {% if p2_win %}
                        {# Winners (Team 2) #}
                        <div class="match-team font-weight-bold">
                            {% if match.team2 %}
                            {{ match.team2.name }}
                            {% elif match.player2 %}
                            {{ match.player2 | display_name }}{% if match.opponent2 %} & {{ match.opponent2 |
                            display_name }}{% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </div>
                        <div class="match-score-pill font-weight-bold">
                            {{ p2_score }}-{{ p1_score }}
                        </div>
                        <div class="match-vs text-muted">vs</div>
                        <div class="match-team">
                            {% if match.team1 %}
                            {{ match.team1.name }}
                            {% elif match.player1 %}
                            {{ match.player1 | display_name }}{% if match.partner %} & {{ match.partner | display_name
                            }}{% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </div>
                        {% else %}
                        {# Winners (Team 1) or Draw #}
                        <div class="match-team {{ 'font-weight-bold' if p1_win else '' }}">
                            {% if match.team1 %}
                            {{ match.team1.name }}
                            {% elif match.player1 %}
                            {{ match.player1 | display_name }}{% if match.partner %} & {{ match.partner | display_name
                            }}{% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </div>
                        <div class="match-score-pill {{ 'font-weight-bold' if p1_win else '' }}">
                            {{ p1_score }}-{{ p2_score }}
                        </div>
                        <div class="match-vs text-muted">vs</div>
                        <div class="match-team">
                            {% if match.team2 %}
                            {{ match.team2.name }}
                            {% elif match.player2 %}
                            {{ match.player2 | display_name }}{% if match.opponent2 %} & {{ match.opponent2 |
                            display_name }}{% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    {% if match.is_upset %}
                    <span class="upset-mini-badge" title="Upset! üî•">üî•</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="manage-group-section">
    <details class="card manage-group-card">
        <summary class="manage-group-summary">Manage Group & Members ({{ members|length }})</summary>
        <div class="manage-group-content">
            <h3>Members</h3>
            <div class="table-container">
                <table class="table-standard responsive-table">
                    <tbody>
                        {% for member in members %}
                        <tr class="clickable-row" data-href="{{ url_for('user.view_user', user_id=member.id) }}">
                            <td data-label="Avatar">
                                <img src="{{ member | avatar_url }}" alt="Profile Picture" class="avatar avatar-md"
                                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                            </td>
                            <td data-label="Username">{{ member.username }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if group.ownerRef.id == current_user_id %}
            <h3>Invite Friends</h3>
            <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ form.friend.label }}
                    {{ form.friend(class="form-control") }}
                </div>
                <input type="submit" value="Invite Friend" class="btn">
            </form>

            <h3>Invite by Email</h3>
            <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
                {{ invite_email_form.hidden_tag() }}
                <div class="form-group">
                    {{ invite_email_form.name.label }}
                    {{ invite_email_form.name(class="form-control") }}
                </div>
                <div class="form-group">
                    {{ invite_email_form.email.label }}
                    {{ invite_email_form.email(class="form-control") }}
                </div>
                <input type="submit" value="Send Invite" class="btn">
            </form>

            <h3>Danger Zone</h3>
            <form method="post" action="{{ url_for('group.delete_group', group_id=group.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="submit" value="Delete Group" class="btn btn-danger"
                    onclick="return confirm('Are you sure you want to permanently delete this group? This action cannot be undone.')">
            </form>
            {% endif %}
        </div>
    </details>
</div>

{% if is_member and pending_members %}
<div class="manage-group-section">
    <details class="card manage-group-card">
        <summary class="manage-group-summary">Manage Pending Invites ({{ pending_members|length }})</summary>
        <div class="manage-group-content">
            <h3>Pending Members</h3>
            <div class="table-container">
                <table class="table-standard responsive-table">
                    <thead>
                        <tr>
                            <th class="pending-invites-avatar-header"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            {% if group.ownerRef.id == current_user_id %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for invite in pending_members %}
                        <tr>
                            <td data-label="Avatar">
                                <img src="{{ invite | avatar_url }}" alt="Profile Picture" class="avatar avatar-md"
                                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                            </td>
                            <td data-label="Name">{{ invite.username or invite.name }}</td>
                            <td data-label="Email">{{ invite.email }}</td>
                            <td data-label="Status">
                                {% if invite.status == 'failed' %}
                                <span class="badge danger" title="{{ invite.last_error }}">Failed</span>
                                {% elif invite.status == 'sending' %}
                                <span class="badge warning">Sending...</span>
                                {% elif invite.status == 'sent' %}
                                <span class="badge success">Sent</span>
                                {% else %}
                                <span class="badge">{{ invite.status or 'Pending' }}</span>
                                {% endif %}
                            </td>
                            {% if group.ownerRef.id == current_user_id %}
                            <td data-label="Actions">
                                <div class="pending-invites-actions">
                                    <form method="post"
                                        action="{{ url_for('group.resend_invite', token=invite.token) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        {% if invite.status == 'failed' %}
                                        <div class="input-group pending-invites-email-group">
                                            <input type="email" name="email" value="{{ invite.email }}" required
                                                class="form-control pending-invites-email-input">
                                        </div>
                                        {% endif %}
                                        <button type="submit" class="btn small">
                                            {% if invite.status == 'failed' %}Retry{% else %}Resend{% endif %}
                                        </button>
                                    </form>
                                    <form method="post"
                                        action="{{ url_for('group.delete_invite', token=invite.token) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger small"
                                            onclick="return confirm('Cancel this invitation?')">Cancel</button>
                                    </form>
                                </div>
                                {% if invite.status == 'failed' and invite.last_error %}
                                <div class="invite-error-message">
                                    {{ invite.last_error }}
                                </div>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </details>
</div>
{% endif %}

<div class="modal fade" id="bragCardModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 400px;">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
            <div class="modal-body p-0">
                <div id="bragCardContainer" class="brag-card">
                    <div class="brag-card-header">
                        <img id="bragCardAvatar" src="{{ url_for('static', filename='user_icon.png') }}" alt="Avatar" class="brag-card-avatar">
                        <h2 id="bragCardUsername" class="brag-card-username"></h2>
                    </div>
                    <div class="brag-card-main">
                        <div id="bragCardStatLabel" class="brag-card-stat-label"></div>
                        <div id="bragCardStatValue" class="brag-card-stat-value"></div>
                    </div>
                    <div class="brag-card-visual">
                        <canvas id="bragCardSparkline"></canvas>
                    </div>
                    <div class="brag-card-footer">
                        Pickaladder - {{ group.name }}
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-white mb-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Screenshot this card to
                        share!</p>
                    <button type="button" class="btn btn-volt" data-dismiss="modal" style="width: auto;">Done</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="shareGroupModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 400px;">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
            <div class="modal-body p-0">
                <div class="social-share-card">
                    <div class="social-share-card-header">Pick-A-Ladder Group</div>
                    <div class="social-share-card-body text-center">
                        <div class="profile-picture-container avatar-lg mx-auto mb-3">
                            <img src="{{ g.user | avatar_url }}" alt="Profile Picture" class="profile-picture">
                        </div>
                        <h2 class="social-share-card-title text-white font-weight-bold">{{ group.name }}</h2>
                        {% set ns = namespace(user_rank='Member') %}
                        {% for player in leaderboard %}
                            {% if player.id == current_user_id %}
                                {% set ns.user_rank = 'Rank #' ~ loop.index %}
                            {% endif %}
                        {% endfor %}
                        <div class="social-share-card-stat">{{ ns.user_rank }}</div>
                    </div>
                    <div class="social-share-card-footer">Join us on pickaladder.io</div>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-white mb-2" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Screenshot this card to share!</p>
                    <button type="button" class="btn btn-volt" data-dismiss="modal" style="width: auto;">Done</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tabbuttons;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tabbuttons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
            tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    let bragCardChart = null;

    function openBragCard(userId, username, avatar, rank, streak) {
        document.getElementById('bragCardUsername').innerText = username;
        document.getElementById('bragCardAvatar').src = avatar;

        // Determine main stat
        const streakNum = parseInt(streak) || 0;
        const rankNum = parseInt(rank) || 0;

        if (rankNum === 1) {
            document.getElementById('bragCardStatLabel').innerText = 'GROUP RANKING';
            document.getElementById('bragCardStatValue').innerText = 'RANK #1';
        } else if (streakNum >= 3) {
            document.getElementById('bragCardStatLabel').innerText = 'CURRENT STREAK';
            document.getElementById('bragCardStatValue').innerText = streakNum + ' WINS';
        } else {
            document.getElementById('bragCardStatLabel').innerText = 'GROUP RANKING';
            document.getElementById('bragCardStatValue').innerText = 'RANK #' + rankNum;
        }

        // Show modal
        $('#bragCardModal').modal('show');

        // Fetch trend data
        fetch(`/group/{{ group.id }}/user-trend/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                renderSparkline(data.dataset.data);
            })
            .catch(err => console.error("Error fetching trend data:", err));
    }

    function renderSparkline(trendData) {
        const canvas = document.getElementById('bragCardSparkline');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        if (bragCardChart) {
            bragCardChart.destroy();
        }

        // Filter out nulls for the sparkline
        const cleanData = trendData.filter(v => v !== null);

        // Fallback color if CSS variable is not available
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() || '#c3ff00';

        bragCardChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: cleanData.map((_, i) => i),
                datasets: [{
                    data: cleanData,
                    borderColor: accentColor,
                    borderWidth: 4,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                scales: {
                    x: { display: false },
                    y: {
                        display: false,
                        beginAtZero: false
                    }
                }
            }
        });
    }
</script>
{% endblock %}