{% extends "layout.html" %}
{% block title %}{{ group.name }}{% endblock %}
{% block content %}
<div class="page-header group-header-content">
    <img src="{{ group.profilePictureUrl if group.profilePictureUrl else (url_for('static', filename='uploads/' + group.profile_picture_path) if group.profile_picture_path else url_for('static', filename='user_icon.png')) }}" alt="Group Picture" class="group-profile-picture">
    <div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <h1>{{ group.name }}</h1>
            {% if is_member %}
                <a href="{{ url_for('match.record_match', group_id=group.id) }}" class="btn">Record a Match</a>
            {% endif %}
            {% if group.ownerRef.id == current_user_id %}
                <a href="{{ url_for('group.edit_group', group_id=group.id) }}" class="btn">Edit Group</a>
            {% endif %}
        </div>
        <p style="margin-bottom: 5px;">Owned by: <a href="{{ url_for('user.view_user', user_id=group['ownerRef'].id) }}">{{ owner.username }}</a></p>
        {% if group.location %}
            <p style="margin-bottom: 5px;"><strong>Location:</strong> {{ group.location }}</p>
        {% endif %}
        <p style="color: #666;">{{ group.description or 'No description provided.' }}</p>
    </div>
</div>

<div class="grid-container">
    <div class="card">
        <h3>Members</h3>
        <div class="table-container">
            <table class="table responsive-table">
                <tbody>
                    {% for member in members %}
                    <tr class="clickable-row" data-href="{{ url_for('user.view_user', user_id=member.id) }}">
                        <td data-label="Avatar">
                            <img src="{{ member.profilePictureUrl or url_for('static', filename='user_icon.png') }}"
                                alt="Profile Picture" class="profile-picture-thumbnail">
                        </td>
                        <td data-label="Username">{{ member.username }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if group.ownerRef.id == current_user_id %}
        <h3 style="margin-top: 20px;">Invite Friends</h3>
        <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.friend.label }}
                {{ form.friend(class="form-control") }}
            </div>
            <input type="submit" value="Invite Friend" class="btn">
        </form>

        <h3 style="margin-top: 20px;">Invite by Email</h3>
        <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
            {{ invite_email_form.hidden_tag() }}
            <div class="form-group">
                {{ invite_email_form.name.label }}
                {{ invite_email_form.name(class="form-control") }}
            </div>
            <div class="form-group">
                {{ invite_email_form.email.label }}
                {{ invite_email_form.email(class="form-control") }}
            </div>
            <input type="submit" value="Send Invite" class="btn">
        </form>

        {% if pending_invites %}
        <h3 style="margin-top: 20px;">Pending Invites</h3>
        <div class="table-container">
            <table class="table responsive-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invite in pending_invites %}
                    <tr>
                        <td data-label="Name">{{ invite.name }}</td>
                        <td data-label="Email">{{ invite.email }}</td>
                        <td data-label="Status">
                            {% if invite.status == 'failed' %}
                                <span class="badge danger" title="{{ invite.last_error }}">Failed</span>
                            {% elif invite.status == 'sending' %}
                                <span class="badge warning">Sending...</span>
                            {% elif invite.status == 'sent' %}
                                <span class="badge success">Sent</span>
                            {% else %}
                                <span class="badge">{{ invite.status or 'Pending' }}</span>
                            {% endif %}
                        </td>
                        <td data-label="Actions">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <form method="post" action="{{ url_for('group.resend_invite', token=invite.token) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <!-- Simple inline update for email if failed -->
                                    {% if invite.status == 'failed' %}
                                    <div class="input-group" style="margin-bottom: 5px;">
                                        <input type="email" name="email" value="{{ invite.email }}" required class="form-control" style="padding: 5px; width: 150px;">
                                    </div>
                                    {% endif %}
                                    <button type="submit" class="btn small">
                                        {% if invite.status == 'failed' %}Retry{% else %}Resend{% endif %}
                                    </button>
                                </form>
                                <form method="post" action="{{ url_for('group.delete_invite', token=invite.token) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger small" onclick="return confirm('Cancel this invitation?')">Cancel</button>
                                </form>
                            </div>
                            {% if invite.status == 'failed' and invite.last_error %}
                                <div style="font-size: 0.8em; color: red; margin-top: 5px; max-width: 200px; word-wrap: break-word;">
                                    {{ invite.last_error }}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <h3 style="margin-top: 20px;">Danger Zone</h3>
        <form method="post" action="{{ url_for('group.delete_group', group_id=group.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="submit" value="Delete Group" class="btn btn-danger"
                onclick="return confirm('Are you sure you want to permanently delete this group? This action cannot be undone.')">
        </form>
        {% endif %}
    </div>

    <div class="card">
        <h3>Group Leaderboard</h3>
        <p>Only matches between group members are shown.</p>
        <div class="table-container">
            <table class="table responsive-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Average Score</th>
                        <th>Games Played</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in leaderboard %}
                    <tr class="{{ 'highlight-row' if player.id == current_user_id else '' }}">
                        <td data-label="Rank">{{ loop.index }}</td>
                        <td data-label="Player"><a href="{{ url_for('user.view_user', user_id=player.id) }}">{{ player.name }}</a></td>
                        <td data-label="Average Score">{{ "%.2f"|format(player.avg_score|float) }}</td>
                        <td data-label="Games Played">{{ player.games_played }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">No matches have been played between members of this group yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
