{% extends "layout.html" %}
{% block title %}{{ group.name }}{% endblock %}
{% block content %}
<div class="page-header group-header-content">
    <img src="{{ group.profilePictureUrl if group.profilePictureUrl else (url_for('static', filename='uploads/' + group.profile_picture_path) if group.profile_picture_path else url_for('static', filename='user_icon.png')) }}" alt="Group Picture" class="group-profile-picture">
    <div>
        <div class="group-header-actions">
            <div class="group-header-title">
                <h1>{{ group.name }}</h1>
                {% if is_member %}
                    <a href="{{ url_for('match.record_match', group_id=group.id) }}" class="btn btn-primary">Record a Match</a>
                {% endif %}
            </div>
            {% if group.ownerRef.id == current_user_id %}
                <a href="{{ url_for('group.edit_group', group_id=group.id) }}" title="Group Settings" class="settings-icon">‚öôÔ∏è</a>
            {% endif %}
        </div>
        <div class="group-meta-info">
            <p>Owned by: <a href="{{ url_for('user.view_user', user_id=group['ownerRef'].id) }}">{{ owner.username }}</a></p>
            {% if group.location %}
                <p><strong>Location:</strong> {{ group.location }}</p>
            {% endif %}
        </div>
        <p class="group-description">{{ group.description or 'No description provided.' }}</p>
    </div>
</div>

<div class="grid-container">
    
    <div>
        <div class="card">
            <h3>Group Leaderboard</h3>
            <p>A live ranking of all group members.</p>

            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'players')">Players</button>
                    <button class="tab-button" onclick="openTab(event, 'teams')">Teams</button>
                </div>

                <div id="players" class="tab-content" style="display: block;">
                    <div class="leaderboard-container">
                        <div class="leaderboard-header">
                            <div class="leaderboard-cell">Rank</div>
                            <div class="leaderboard-cell">Player</div>
                            <div class="leaderboard-cell">Avg. Score</div>
                            <div class="leaderboard-cell">Form</div>
                            <div class="leaderboard-cell">Games</div>
                        </div>
                        <div class="leaderboard-body">
                            {% for player in leaderboard %}
                            <div class="leaderboard-row {{ 'highlight-user' if player.id == g.user['uid'] else '' }}">
                                <div class="leaderboard-cell" data-label="Rank">
                                    <div class="player-rank">
                                        <span>
                                            {% if loop.index == 1 %}ü•á
                                            {% elif loop.index == 2 %}ü•à
                                            {% elif loop.index == 3 %}ü•â
                                            {% else %}{{ loop.index }}{% endif %}
                                        </span>
                                        <span class="rank-trend">
                                            {% if player.rank_change is number and player.rank_change > 0 %}
                                                <span class="trend-up">‚ñ≤</span>
                                            {% elif player.rank_change is number and player.rank_change < 0 %}
                                                <span class="trend-down">‚ñº</span>
                                            {% elif player.rank_change == 'new' %}
                                                <span class="trend-new">‚óè</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="leaderboard-cell" data-label="Player">
                                    <a href="{{ url_for('user.view_user', user_id=player.id) }}" class="player-link">
                                        <img src="{{ player | avatar_url }}" alt="{{ player.name }}" class="profile-picture-thumbnail avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                        <span class="player-name">
                                            {{ player.name }}
                                            {% if player.is_on_fire %}
                                                <span title="{{ player.streak }} Game Streak!">üî•</span>
                                            {% endif %}
                                        </span>
                                    </a>
                                </div>
                                <div class="leaderboard-cell" data-label="Avg. Score">{{ "%.2f"|format(player.avg_score|float) }}</div>
                                <div class="leaderboard-cell" data-label="Form">
                                    <div class="form-dots">
                                        {% for result in player.form %}
                                            <span class="form-dot {{ result }}"></span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="leaderboard-cell" data-label="Games">{{ player.games_played }}</div>
                            </div>
                            {% else %}
                            <div class="leaderboard-empty">
                                <p>No matches have been played between members of this group yet.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div id="teams" class="tab-content" style="display: none;">
                    <div class="leaderboard-container">
                        <div class="leaderboard-header">
                            <div class="leaderboard-cell">Rank</div>
                            <div class="leaderboard-cell">Team</div>
                            <div class="leaderboard-cell">Win %</div>
                            <div class="leaderboard-cell">Record</div>
                            <div class="leaderboard-cell">Games</div>
                        </div>
                        <div class="leaderboard-body">
                            {% for team in team_leaderboard %}
                            <div class="leaderboard-row">
                                <div class="leaderboard-cell" data-label="Rank">
                                    <div class="player-rank">
                                        <span>
                                            {% if loop.index == 1 %}ü•á
                                            {% elif loop.index == 2 %}ü•à
                                            {% elif loop.index == 3 %}ü•â
                                            {% else %}{{ loop.index }}{% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="leaderboard-cell" data-label="Team">
                                    <div class="team-members">
                                        {% for member in team.member_details %}
                                            <a href="{{ url_for('user.view_user', user_id=member.id) }}" class="player-link">
                                                <img src="{{ member | avatar_url }}" alt="{{ member.name }}" class="profile-picture-thumbnail avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                            </a>
                                        {% endfor %}
                                        <span class="team-name">{{ team.name }}</span>
                                    </div>
                                </div>
                                <div class="leaderboard-cell" data-label="Win %">{{ "%.1f"|format(team.win_percentage) }}%</div>
                                <div class="leaderboard-cell" data-label="Record">{{ team.stats.get('wins', 0) }}-{{ team.stats.get('losses', 0) }}</div>
                                <div class="leaderboard-cell" data-label="Games">{{ team.total_games }}</div>
                            </div>
                            {% else %}
                            <div class="leaderboard-empty">
                                <p>No teams have been formed in this group yet.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="leaderboard-trend-link">
                <a href="{{ url_for('group.view_leaderboard_trend', group_id=group.id) }}">View Leaderboard Trend Chart</a>
            </div>
        </div>
    </div>

    <div>
        {% if best_buds %}
        <div class="card best-buds-card">
            <h3>üëØ Best Buds</h3>
            <div class="best-buds-container">
                {% for member in best_buds.member_details %}
                    <img src="{{ member | avatar_url }}" alt="{{ member | smart_display_name }}" class="profile-picture-thumbnail avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                    {% if not loop.last %}<span class="plus-sign">+</span>{% endif %}
                {% endfor %}
            </div>
            <p>
                {% for member in best_buds.member_details %}
                    {{ member | smart_display_name }}{% if not loop.last %} & {% endif %}
                {% endfor %}: {{ best_buds.stats.get('wins', 0) }} Wins Together!
            </p>
        </div>
        {% endif %}

        <div class="card">
            <h3>Rivalry Check</h3>
            <div class="rivalry-check-form">
                <div class="form-group">
                    <label for="player1-select">Player 1</label>
                    <select id="player1-select" class="form-control">
                        <option value="">Select a player</option>
                        {% for member in members %}
                            <option value="{{ member.id }}" {{ 'selected' if member.id == playerA_id else '' }}>{{ member.name or member.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="player2-select">Player 2</label>
                    <select id="player2-select" class="form-control">
                        <option value="">Select a player</option>
                        {% for member in members %}
                            <option value="{{ member.id }}" {{ 'selected' if member.id == playerB_id else '' }}>{{ member.name or member.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="head-to-head-stats" class="rivalry-stats-container">
                {% if rivalry_stats %}
                    <div class="tale-of-the-tape">
                        <h3>Tale of the Tape</h3>
                        <div class="participants">
                            <div class="participant">
                                {% set p1 = members|selectattr("id", "equalto", playerA_id)|first %}
                                <img src="{{ p1 | avatar_url }}" alt="{{ p1.name if p1 else 'Player 1' }}" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                <span>{{ p1.name if p1 else 'Player 1' }}</span>
                            </div>
                            <div class="score">
                                {% if rivalry_stats.wins + rivalry_stats.losses > 0 and (rivalry_stats.wins - rivalry_stats.losses)|abs <= 1 %}
                                    <div class="rivalry-badge hot">üî• Heated</div>
                                {% endif %}
                                <span>{{ rivalry_stats.wins }} - {{ rivalry_stats.losses }}</span>
                            </div>
                            <div class="participant">
                                {% set p2 = members|selectattr("id", "equalto", playerB_id)|first %}
                                <img src="{{ p2 | avatar_url }}" alt="{{ p2.name if p2 else 'Player 2' }}" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                <span>{{ p2.name if p2 else 'Player 2' }}</span>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-bar">
                                <span>Avg Points Scored</span>
                                <span>{{ "%.1f"|format(rivalry_stats.avg_points_scored.playerA) }} - {{ "%.1f"|format(rivalry_stats.avg_points_scored.playerB) }}</span>
                            </div>
                            <div class="stat-bar">
                                <span>Partnership Record</span>
                                <span>Chemistry: {{ rivalry_stats.partnership_record.wins }}W - {{ rivalry_stats.partnership_record.losses }}L</span>
                            </div>
                        </div>
                        <div class="recent-clashes">
                            <h4>Recent Clashes</h4>
                            <ul>
                            {% for match in rivalry_stats.matches %}
                                <li>
                                    {% set player1_wins = (playerA_id in match.team1_ids and match.player1Score > match.player2Score) or (playerA_id in match.team2_ids and match.player2Score > match.player1Score) %}
                                    {% if player1_wins %}<strong>{% endif %}{{ p1.name if p1 else 'Player 1' }}{% if player1_wins %}</strong>{% endif %}
                                    {% if playerA_id in match.team1_ids %}{{ match.player1Score }} - {{ match.player2Score }}{% else %}{{ match.player2Score }} - {{ match.player1Score }}{% endif %}
                                    {% if not player1_wins %}<strong>{% endif %}{{ p2.name if p2 else 'Player 2' }}{% if not player1_wins %}</strong>{% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div id="rivalry-cta-container" style="text-align: center; margin-top: 1rem;">
                {% if rivalry_stats %}
                    <a href="{{ url_for('match.record_match', group_id=group.id, player1_id=playerA_id, player2_id=playerB_id) }}" class="btn btn-primary">Settle the Score</a>
                {% endif %}
            </div>
        </div>

        {% if recent_matches %}
        <div class="card">
            <h3>Recent Matches</h3>
            <div class="table-container">
                <table class="table responsive-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Team 1</th>
                            <th>Team 2</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in recent_matches %}
                        <tr>
                            <td data-label="Date">{{ match.matchDate.strftime('%Y-%m-%d') if match.matchDate else 'N/A' }}</td>
                            <td data-label="Team 1">
                                {% if match.team1 %}
                                    {{ match.team1.name }}
                                    {% if g.user and g.user.uid in match.team1.member_ids %}
                                        <a href="{{ url_for('teams.edit_team', team_id=match.team1.id) }}" class="icon-link" title="Edit Team Name">‚úèÔ∏è</a>
                                    {% endif %}
                                {% elif match.player1 %}
                                    {% if match.player1.id != 'unknown' %}
                                        <a href="{{ url_for('user.view_user', user_id=match.player1.id) }}">{{ match.player1.username }}</a>
                                    {% else %}
                                        {{ match.player1.username }}
                                    {% endif %}
                                    {% if match.partner %}
                                        &
                                        {% if match.partner.id != 'unknown' %}
                                            <a href="{{ url_for('user.view_user', user_id=match.partner.id) }}">{{ match.partner.username }}</a>
                                        {% else %}
                                            {{ match.partner.username }}
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    Unknown
                                {% endif %}
                                {% if match.is_upset and match.winner == 'team1' %}
                                    <span title="Giant Slayer! Beat a higher-ranked opponent.">üó°Ô∏è</span>
                                {% endif %}
                            </td>
                            <td data-label="Team 2">
                                {% if match.team2 %}
                                    {{ match.team2.name }}
                                    {% if g.user and g.user.uid in match.team2.member_ids %}
                                        <a href="{{ url_for('teams.edit_team', team_id=match.team2.id) }}" class="icon-link" title="Edit Team Name">‚úèÔ∏è</a>
                                    {% endif %}
                                {% elif match.player2 %}
                                    {% if match.player2.id != 'unknown' %}
                                        <a href="{{ url_for('user.view_user', user_id=match.player2.id) }}">{{ match.player2.username }}</a>
                                    {% else %}
                                        {{ match.player2.username }}
                                    {% endif %}
                                    {% if match.opponent2 %}
                                        &
                                        {% if match.opponent2.id != 'unknown' %}
                                            <a href="{{ url_for('user.view_user', user_id=match.opponent2.id) }}">{{ match.opponent2.username }}</a>
                                        {% else %}
                                            {{ match.opponent2.username }}
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    Unknown
                                {% endif %}
                                {% if match.is_upset and match.winner == 'team2' %}
                                    <span title="Giant Slayer! Beat a higher-ranked opponent.">üó°Ô∏è</span>
                                {% endif %}
                            </td>
                            <td data-label="Score" class="{{ 'upset-score' if match.is_upset else '' }}">
                                {{ match.player1Score }} - {{ match.player2Score }}
                                {% if (match.player1Score - match.player2Score)|abs == 2 %}
                                    <span class="badge badge-close-call">Close Call</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="manage-group-section">
    <details class="card manage-group-card">
        <summary class="manage-group-summary">Manage Group & Members ({{ members|length }})</summary>
        <div class="manage-group-content">
            <h3>Members</h3>
            <div class="table-container">
                <table class="table responsive-table">
                    <tbody>
                        {% for member in members %}
                        <tr class="clickable-row" data-href="{{ url_for('user.view_user', user_id=member.id) }}">
                            <td data-label="Avatar">
                                <img src="{{ member | avatar_url }}"
                                    alt="Profile Picture" class="profile-picture-thumbnail avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                            </td>
                            <td data-label="Username">{{ member.username }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if group.ownerRef.id == current_user_id %}
            <h3>Invite Friends</h3>
            <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ form.friend.label }}
                    {{ form.friend(class="form-control") }}
                </div>
                <input type="submit" value="Invite Friend" class="btn">
            </form>

            <h3>Invite by Email</h3>
            <form method="post" action="{{ url_for('group.view_group', group_id=group.id) }}">
                {{ invite_email_form.hidden_tag() }}
                <div class="form-group">
                    {{ invite_email_form.name.label }}
                    {{ invite_email_form.name(class="form-control") }}
                </div>
                <div class="form-group">
                    {{ invite_email_form.email.label }}
                    {{ invite_email_form.email(class="form-control") }}
                </div>
                <input type="submit" value="Send Invite" class="btn">
            </form>

            <h3>Danger Zone</h3>
            <form method="post" action="{{ url_for('group.delete_group', group_id=group.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="submit" value="Delete Group" class="btn btn-danger"
                    onclick="return confirm('Are you sure you want to permanently delete this group? This action cannot be undone.')">
            </form>
            {% endif %}
        </div>
    </details>
</div>

{% if is_member and pending_members %}
<div class="manage-group-section">
    <details class="card manage-group-card">
        <summary class="manage-group-summary">Manage Pending Invites ({{ pending_members|length }})</summary>
        <div class="manage-group-content">
            <h3>Pending Members</h3>
            <div class="table-container">
                <table class="table responsive-table">
                    <thead>
                        <tr>
                            <th class="pending-invites-avatar-header"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            {% if group.ownerRef.id == current_user_id %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for invite in pending_members %}
                        <tr>
                            <td data-label="Avatar">
                                <img src="{{ invite | avatar_url }}"
                                     alt="Profile Picture" class="profile-picture-thumbnail avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                            </td>
                            <td data-label="Name">{{ invite.username or invite.name }}</td>
                            <td data-label="Email">{{ invite.email }}</td>
                            <td data-label="Status">
                                {% if invite.status == 'failed' %}
                                    <span class="badge danger" title="{{ invite.last_error }}">Failed</span>
                                {% elif invite.status == 'sending' %}
                                    <span class="badge warning">Sending...</span>
                                {% elif invite.status == 'sent' %}
                                    <span class="badge success">Sent</span>
                                {% else %}
                                    <span class="badge">{{ invite.status or 'Pending' }}</span>
                                {% endif %}
                            </td>
                            {% if group.ownerRef.id == current_user_id %}
                            <td data-label="Actions">
                                <div class="pending-invites-actions">
                                    <form method="post" action="{{ url_for('group.resend_invite', token=invite.token) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        {% if invite.status == 'failed' %}
                                        <div class="input-group pending-invites-email-group">
                                            <input type="email" name="email" value="{{ invite.email }}" required class="form-control pending-invites-email-input">
                                        </div>
                                        {% endif %}
                                        <button type="submit" class="btn small">
                                            {% if invite.status == 'failed' %}Retry{% else %}Resend{% endif %}
                                        </button>
                                    </form>
                                    <form method="post" action="{{ url_for('group.delete_invite', token=invite.token) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-danger small" onclick="return confirm('Cancel this invitation?')">Cancel</button>
                                    </form>
                                </div>
                                {% if invite.status == 'failed' and invite.last_error %}
                                    <div class="invite-error-message">
                                        {{ invite.last_error }}
                                    </div>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </details>
</div>
{% endif %}

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tabbuttons;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tabbuttons = document.getElementsByClassName("tab-button");
    for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.addEventListener('DOMContentLoaded', function() {
    const player1Select = document.getElementById('player1-select');
    const player2Select = document.getElementById('player2-select');
    const statsContainer = document.getElementById('head-to-head-stats');
    const ctaContainer = document.getElementById('rivalry-cta-container');
    const members = {{ members | tojson }};

    function getProfilePictureUrl(playerId) {
        const member = members.find(m => m.id === playerId);
        if (member && member.profilePictureUrl) return member.profilePictureUrl;
        const seed = playerId || "default";
        return `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=2e7d32,ffc107,1976d2`;
    }

    function fetchAndDisplayStats() {
        const player1Id = player1Select.value;
        const player2Id = player2Select.value;

        if (player1Id === player2Id || !player1Id || !player2Id) {
            statsContainer.innerHTML = '';
            ctaContainer.innerHTML = '';
            return;
        }

        statsContainer.innerHTML = '<p>Loading...</p>';
        ctaContainer.innerHTML = '';

        const url = `/group/{{ group.id }}/stats/rivalry?playerA_id=${player1Id}&playerB_id=${player2Id}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const player1Name = player1Select.options[player1Select.selectedIndex].text;
                const player2Name = player2Select.options[player2Select.selectedIndex].text;
                const player1AvatarUrl = getProfilePictureUrl(player1Id);
                const player2AvatarUrl = getProfilePictureUrl(player2Id);

                const p1H2HWins = data.wins;
                const p2H2HWins = data.losses;
                const totalH2H = p1H2HWins + p2H2HWins;
                const diff = Math.abs(p1H2HWins - p2H2HWins);

                let badgeHtml = '';
                if (totalH2H > 0 && diff <= 1) {
                    badgeHtml = `<div class="rivalry-badge hot">üî• Heated</div>`;
                }

                let recentClashesHtml = '<div class="recent-clashes"><h4>Recent Clashes</h4><ul>';
                data.matches.forEach(match => {
                    const p1Score = match.player1Score || 0;
                    const p2Score = match.player2Score || 0;
                    const winner = p1Score > p2Score ? 'team1' : (p2Score > p1Score ? 'team2' : 'draw');
                    const team1Score = p1Score;
                    const team2Score = p2Score;

                    const team1_ids = match.team1_ids || [match.player1Id, match.partnerId];
                    const team2_ids = match.team2_ids || [match.player2Id, match.opponent2Id];

                    const player1_is_team1 = team1_ids.includes(player1Id);
                    const player2_is_team2 = team2_ids.includes(player2Id);

                    const player1_is_team2 = team2_ids.includes(player1Id);
                    const player2_is_team1 = team1_ids.includes(player2Id);

                    let player1_wins = false;
                    if ((player1_is_team1 && winner === 'team1') || (player1_is_team2 && winner === 'team2')) {
                        player1_wins = true;
                    }

                    let scoreHtml;
                    if (player1_is_team1) {
                        scoreHtml = `${team1Score} - ${team2Score}`;
                    } else {
                        scoreHtml = `${team2Score} - ${team1Score}`;
                    }

                    let player1Display = player1Name;
                    let player2Display = player2Name;

                    if (player1_wins) {
                        player1Display = `<strong>${player1Name}</strong>`;
                    } else {
                        player2Display = `<strong>${player2Name}</strong>`;
                    }

                    recentClashesHtml += `
                        <li>${player1Display} ${scoreHtml} ${player2Display}</li>
                    `;
                });
                recentClashesHtml += '</ul></div>';


                let taleOfTheTapeHtml = `
                    <div class="tale-of-the-tape">
                        <h3>Tale of the Tape</h3>
                        <div class="participants">
                            <div class="participant">
                                <img src="${player1AvatarUrl}" alt="${player1Name}" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                <span>${player1Name}</span>
                            </div>
                            <div class="score">
                                ${badgeHtml}
                                <span>${p1H2HWins} - ${p2H2HWins}</span>
                            </div>
                            <div class="participant">
                                <img src="${player2AvatarUrl}" alt="${player2Name}" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='user_icon.png') }}';">
                                <span>${player2Name}</span>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-bar">
                                <span>Avg Points Scored</span>
                                <span>${data.avg_points_scored.playerA.toFixed(1)} - ${data.avg_points_scored.playerB.toFixed(1)}</span>
                            </div>
                            <div class="stat-bar">
                                <span>Partnership Record</span>
                                <span>Chemistry: ${data.partnership_record.wins}W - ${data.partnership_record.losses}L</span>
                            </div>
                        </div>
                        ${recentClashesHtml}
                    </div>
                `;

                statsContainer.innerHTML = taleOfTheTapeHtml;

                // Add CTA button
                const recordMatchUrl = new URL("{{ url_for('match.record_match', group_id=group.id) }}", window.location.origin);
                recordMatchUrl.searchParams.set('player1_id', player1Id);
                recordMatchUrl.searchParams.set('player2_id', player2Id);

                ctaContainer.innerHTML = `
                    <a href="${recordMatchUrl.toString()}" class="btn btn-primary">Settle the Score</a>
                `;
            })
            .catch(error => {
                statsContainer.innerHTML = '<p class="text-danger">Error loading stats.</p>';
                console.error('Error fetching head-to-head stats:', error);
            });
    }

    player1Select.addEventListener('change', fetchAndDisplayStats);
    player2Select.addEventListener('change', fetchAndDisplayStats);
});
</script>
{% endblock %}
