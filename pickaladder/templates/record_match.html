{% extends "layout.html" %}
{% block title %}Record Match{% endblock %}
{% block content %}
<div class="form-container">
    <h2>Record Match {% if tournament_name %} - {{ tournament_name }} {% endif %}</h2>
    {% for field, errors in form.errors.items() %}
        <div class="alert alert-danger">
            {{ ', '.join(errors) }}
        </div>
    {% endfor %}
    <form name="record-match-form" method="POST">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.match_type.label }}
            {{ form.match_type(class="form-control", onchange="toggleFields()") }}
        </div>

        <!-- Team 1 / Player 1 -->
        <div class="form-group">
            {{ form.player1.label }}
            {{ form.player1(class="form-control") }}
        </div>
        <div class="form-group" id="partner-group" style="display: none;">
            {{ form.partner.label }}
            {{ form.partner(class="form-control") }}
        </div>

        <div class="form-group">
            <label id="player1-score-label" for="player1_score">Your Score</label>
            {{ form.player1_score(class="form-control") }}
        </div>

        <hr>

        <!-- Team 2 / Player 2 -->
        <div class="form-group">
            <label id="player2-label" for="player2">Opponent</label>
            {{ form.player2(class="form-control") }}
        </div>

        <div class="form-group" id="opponent2-group" style="display: none;">
            {{ form.opponent2.label }}
            {{ form.opponent2(class="form-control") }}
        </div>

        <div class="form-group">
            <label id="player2-score-label" for="player2_score">Opponent's Score</label>
            {{ form.player2_score(class="form-control") }}
        </div>

        <hr>

        <div class="form-group">
            {{ form.match_date.label }}
            {{ form.match_date(class="form-control") }}
        </div>

        <div id="prediction-preview" style="display: none; margin-bottom: 20px;">
            {% set prediction = {'team1_prob': 50, 'team2_prob': 50, 'insight': 'Calculating...'} %}
            {% include 'match/preview.html' %}
        </div>

        <button type="submit" class="btn btn-volt">Record Match</button>
        {% if tournament_id %}
            <a href="{{ url_for('tournament.view_tournament', tournament_id=tournament_id) }}" class="btn btn-danger" style="margin-top: 10px;">Cancel</a>
        {% elif group_id %}
            <a href="{{ url_for('group.view_group', group_id=group_id) }}" class="btn btn-danger" style="margin-top: 10px;">Cancel</a>
        {% else %}
            <a href="{{ url_for('user.dashboard') }}" class="btn btn-danger" style="margin-top: 10px;">Cancel</a>
        {% endif %}
    </form>
    <script>
        document.getElementById('match_date').valueAsDate = new Date();

        function updatePrediction() {
            const matchType = document.getElementById('match_type').value;
            const p1 = document.getElementById('player1').value;
            const p2 = document.getElementById('player2').value;
            const partner = document.getElementById('partner').value;
            const opponent2 = document.getElementById('opponent2').value;

            let team1 = p1;
            let team2 = p2;

            if (matchType === 'doubles') {
                if (!p1 || !partner || !p2 || !opponent2) {
                    document.getElementById('prediction-preview').style.display = 'none';
                    return;
                }
                team1 = `${p1},${partner}`;
                team2 = `${p2},${opponent2}`;
            } else {
                if (!p1 || !p2) {
                    document.getElementById('prediction-preview').style.display = 'none';
                    return;
                }
            }

            const previewDiv = document.getElementById('prediction-preview');
            previewDiv.style.display = 'block';
            const insightText = previewDiv.querySelector('.insight-text');
            insightText.textContent = 'Calculating...';

            fetch(`/stats/prediction?team1_id=${team1}&team2_id=${team2}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        previewDiv.style.display = 'none';
                        return;
                    }
                    const bars = previewDiv.querySelectorAll('.progress-bar');
                    bars[0].style.width = data.team1_prob + '%';
                    bars[0].textContent = data.team1_prob + '%';
                    bars[0].setAttribute('aria-valuenow', data.team1_prob);

                    bars[1].style.width = data.team2_prob + '%';
                    bars[1].textContent = data.team2_prob + '%';
                    bars[1].setAttribute('aria-valuenow', data.team2_prob);

                    insightText.textContent = data.insight;
                })
                .catch(error => {
                    console.error('Error fetching prediction:', error);
                    previewDiv.style.display = 'none';
                });
        }

        function toggleFields() {
            var matchType = document.getElementById('match_type').value;
            var partnerGroup = document.getElementById('partner-group');
            var opponent2Group = document.getElementById('opponent2-group');

            var player1ScoreLabel = document.getElementById('player1-score-label');
            var player2Label = document.getElementById('player2-label');
            var player2ScoreLabel = document.getElementById('player2-score-label');

            if (matchType === 'doubles') {
                partnerGroup.style.display = 'block';
                opponent2Group.style.display = 'block';
                player1ScoreLabel.innerText = 'Team 1 Score';
                player2Label.innerText = 'Opponent 1';
                player2ScoreLabel.innerText = 'Team 2 Score';
            } else {
                partnerGroup.style.display = 'none';
                opponent2Group.style.display = 'none';
                player1ScoreLabel.innerText = 'Your Score';
                player2Label.innerText = 'Opponent';
                player2ScoreLabel.innerText = 'Opponent\'s Score';
            }
        }

        // Initialize state
        toggleFields();

        // Mutual Exclusivity for Player Dropdowns
        const playerDropdowns = [
            document.getElementById('player1'),
            document.getElementById('partner'),
            document.getElementById('player2'),
            document.getElementById('opponent2')
        ];

        function updateDropdowns() {
            const selectedValues = playerDropdowns.map(dropdown => dropdown.value).filter(Boolean);

            playerDropdowns.forEach(dropdown => {
                Array.from(dropdown.options).forEach(option => {
                    if (selectedValues.includes(option.value) && option.value !== dropdown.value) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                });
            });
        }

        playerDropdowns.forEach(dropdown => {
            dropdown.addEventListener('change', () => {
                updateDropdowns();
                updatePrediction();
            });
        });

        document.getElementById('match_type').addEventListener('change', updatePrediction);

        // Initial call to set the state
        updateDropdowns();
    </script>
    <script src="{{ url_for('static', filename='js/optimistic_submission.js') }}"></script>
</div>
{% endblock %}
