{% extends "layout.html" %}
{% block title %}Leaderboard Trend{% endblock %}

{% block extra_head %}
<style>
    .chart-container {
        position: relative;
        height: 60vh;
        max-height: 500px;
        width: 100%;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .user-stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .stat-card {
        background-color: var(--surface-color);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stat-card h3 {
        margin: 0;
        font-size: 1.2em;
        color: var(--text-color-secondary);
    }
    .stat-card p {
        margin: 5px 0 0;
        font-size: 2.5em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .win-loss {
        font-size: 1.5em !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Performance Trend: {{ group.name }}</h1>
</div>

<div class="chart-container mb-4">
    <canvas id="leaderboardChart"></canvas>
</div>

<div class="page-header">
    <h2>Your Performance Snapshot</h2>
</div>
<div class="user-stats-container">
    <div class="stat-card">
        <h3>Rank</h3>
        <p>#{{ user_stats.rank }}</p>
    </div>
    <div class="stat-card">
        <h3>Wins / Losses</h3>
        <p class="win-loss">{{ user_stats.wins }} / {{ user_stats.losses }}</p>
    </div>
    <div class="stat-card">
        <h3>Current Streak</h3>
        <p>{{ user_stats.win_streak }} Wins</p>
    </div>
    <div class="stat-card">
        <h3>Longest Streak</h3>
        <p>{{ user_stats.longest_streak }} Wins</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('leaderboardChart').getContext('2d');
        let trendData = {{ trend_data | tojson }};

        // Limit data points on mobile for better visibility
        if (window.innerWidth <= 768 && trendData.labels.length > 10) {
            const sliceIndex = trendData.labels.length - 10;
            trendData.labels = trendData.labels.slice(sliceIndex);
            trendData.datasets.forEach(dataset => {
                dataset.data = dataset.data.slice(sliceIndex);
            });
        }

        const currentUserId = "{{ g.user['uid'] }}";
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() || '#84CC16';

        trendData.datasets.forEach((dataset) => {
            dataset.tension = 0.3; // Smooth curves
            if (dataset.id === currentUserId) {
                dataset.borderColor = accentColor;
                dataset.backgroundColor = accentColor;
                dataset.borderWidth = 4;
                dataset.order = 1;
                dataset.pointRadius = 5;
                dataset.pointHoverRadius = 8;
            } else {
                dataset.borderColor = '#E5E7EB';
                dataset.backgroundColor = '#E5E7EB';
                dataset.borderWidth = 2;
                dataset.pointRadius = 0;
                dataset.order = 10;
            }
        });

        // Plugin to draw profile pictures on the chart
        const pointAvatars = {
            id: 'pointAvatars',
            afterDraw: chart => {
                const ctx = chart.ctx;
                const datasets = chart.data.datasets;

                // Helper to draw a single avatar
                const drawAvatar = (dataset, index) => {
                    const meta = chart.getDatasetMeta(index);
                    if (meta.hidden) return;
                    const lastPoint = meta.data[meta.data.length - 1];
                    if (!lastPoint) return;

                    const img = new Image();
                    img.src = dataset.profilePictureUrl || '{{ url_for('static', filename='user_icon.png') }}';

                    const size = dataset.id === currentUserId ? 32 : 24;
                    const x = lastPoint.x + 10;
                    const y = lastPoint.y - (size / 2);

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.clip();
                    ctx.drawImage(img, x, y, size, size);
                    ctx.restore();
                };

                // Draw others first, then hero last so they are on top
                datasets.forEach((dataset, i) => {
                    if (dataset.id !== currentUserId) drawAvatar(dataset, i);
                });
                datasets.forEach((dataset, i) => {
                    if (dataset.id === currentUserId) drawAvatar(dataset, i);
                });
            }
        };

        new Chart(ctx, {
            type: 'line',
            data: trendData,
            plugins: [pointAvatars],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false,
                            drawOnChartArea: false,
                            drawTicks: false,
                            color: 'transparent',
                            borderColor: 'transparent'
                        },
                        title: {
                            display: true,
                            text: 'Match Date'
                        }
                    },
                    y: {
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            display: false,
                            drawBorder: false,
                            drawOnChartArea: false,
                            drawTicks: false,
                            color: 'transparent',
                            borderColor: 'transparent'
                        },
                        title: {
                            display: true,
                            text: 'Average Score'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    });
</script>
{% endblock %}
