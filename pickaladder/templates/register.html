{% extends "layout.html" %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="form-container">
    <h2>Register</h2>
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <form method="post">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.username.label }}
            {{ form.username(class="form-control") }}
            {% if form.username.errors %}
                <ul class=errors>
                {% for error in form.username.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.password.label }}
            {{ form.password(class="form-control") }}
            {% if form.password.errors %}
                <ul class=errors>
                {% for error in form.password.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
            <small style="color: #6c757d; font-size: 0.875em;">
                Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, and one number.
            </small>
        </div>
        <div class="form-group">
            {{ form.confirm_password.label }}
            {{ form.confirm_password(class="form-control") }}
            {% if form.confirm_password.errors %}
                <ul class=errors>
                {% for error in form.confirm_password.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.email.label }}
            {{ form.email(class="form-control") }}
            {% if form.email.errors %}
                <ul class=errors>
                {% for error in form.email.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.name.label }}
            {{ form.name(class="form-control") }}
            {% if form.name.errors %}
                <ul class=errors>
                {% for error in form.name.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.dupr_rating.label }}
            {{ form.dupr_rating(class="form-control") }}
            {% if form.dupr_rating.errors %}
                <ul class=errors>
                {% for error in form.dupr_rating.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
        <button type="submit" name="submit" class="btn">Register</button>
    </form>
    <div class="or-separator">OR</div>
    <button id="google-signin-btn" class="btn btn-google">Sign up with Google</button>
    <p class="text-center" style="margin-top: 20px;">Already have an account? <a href="{{ url_for('auth.login') }}">Login here</a>.</p>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const googleSignInButton = document.getElementById('google-signin-btn');

    googleSignInButton.addEventListener('click', function() {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider)
            .then((result) => {
                return result.user.getIdToken();
            })
            .then((idToken) => {
                return fetch("{{ url_for('auth.session_login') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify({ idToken: idToken }),
                });
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "{{ url_for('user.dashboard') }}";
                } else {
                    throw new Error("Server-side session creation failed.");
                }
            })
            .catch((error) => {
                const errorMessage = error.message;
                const flashes = document.querySelector('.flashes');
                flashes.innerHTML = ''; // Clear previous messages
                const flash = document.createElement('div');
                flash.className = 'alert alert-danger';
                flash.textContent = `Google Sign-in failed: ${errorMessage}`;
                flashes.appendChild(flash);
            });
    });
});
</script>
{% endblock %}
