{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
    <div id="dashboard-content">
        {# Section: Tournament Invites (Top Priority Alert Banner) #}
        {% if pending_tournament_invites %}
            {% for tournament in pending_tournament_invites %}
                <div class="game-card tournament-invite-card" style="margin-bottom: 20px; border-left: 5px solid var(--accent-color);">
                    <div style="flex: 2;">
                        <div style="font-weight: 600; font-size: 1.1rem; color: var(--accent-color);">üèÜ You've been invited!</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 4px;">{{ tournament.name }}</div>
                        <div class="text-muted small">Starts {{ tournament.date }}</div>
                    </div>
                    <div style="flex: 1; display: flex; justify-content: flex-end; gap: 10px; align-items: center;">
                        <form action="{{ url_for('tournament.accept_invite', tournament_id=tournament.id) }}" method="post" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-primary" style="width: auto; margin: 0;">Accept</button>
                        </form>
                        <form action="{{ url_for('tournament.decline_invite', tournament_id=tournament.id) }}" method="post" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-danger" style="width: auto; margin: 0;">Decline</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <div class="hero-stats-card">
            <button id="edit-profile-toggle" class="btn-edit-gear" title="Edit Profile">‚öôÔ∏è</button>
            <div class="hero-left-panel">
                 <img id="hero-profile-img" src="{{ user | avatar_url }}" alt="Profile Picture" class="profile-picture-large">
                 <div class="hero-name-and-edit">
                    <h2 id="hero-username-text">{{ user.name if user.name else user.username }}</h2>
                 </div>
            </div>
            <div class="hero-right-panel">
                <div id="vanity-stats-container" class="vanity-stats-container">
                    <div class="vanity-stat">
                        <div class="stat-value">{{ stats.total_games }}</div>
                        <div class="stat-label text-muted">Total Matches</div>
                    </div>
                    <div class="vanity-stat">
                        <div class="stat-value">{{ stats.win_rate | round | int }}%</div>
                        <div class="stat-label text-muted">Win %</div>
                    </div>
                    <div class="vanity-stat">
                        <div class="stat-value {{ 'text-success' if stats.streak_type == 'W' else 'text-danger' if stats.streak_type == 'L' else '' }}">{{ stats.current_streak }}{{ stats.streak_type if stats.total_games > 0 else 'N/A' }}</div>
                        <div class="stat-label text-muted">Current Streak</div>
                    </div>
                </div>
                <a href="{{ url_for('match.record_match') }}" class="btn btn-primary">Record a Match</a>
            </div>
        </div>

        <div class="dashboard-columns">
            {# Left Column: Recent Activity #}
            <div class="dashboard-column-left">
                <div class="card">
                    <div class="header-with-button">
                        <h3>Recent Activity</h3>
                    </div>
                    <div id="latest-games-feed" class="pb-5">
                        {% for match in matches %}
                            <div class="game-card {{ 'game-won' if match.user_result == 'win' else 'game-lost' }}">
                                <div class="game-date">
                                    {% if match.date and match.date != 'N/A' %}
                                        {% if match.date is string %}
                                            {{ match.date }}
                                        {% else %}
                                            {{ match.date.strftime('%b %d, %Y') }}
                                        {% endif %}
                                    {% else %}
                                        Date N/A
                                    {% endif %}
                                </div>
                                <div class="game-opponent">
                                    {% if match.match_type == 'doubles' %}
                                        {% set in_team1 = user.uid in match.player1|map(attribute='id') %}
                                        {% if in_team1 %}
                                            {% set partner = match.player1[1] if match.player1[0].id == user.uid else match.player1[0] %}
                                            {% set opponent_name = match.team2_name %}
                                        {% else %}
                                            {% set partner = match.player2[1] if match.player2[0].id == user.uid else match.player2[0] %}
                                            {% set opponent_name = match.team1_name %}
                                        {% endif %}
                                        (You & {{ partner.username }}) vs {{ opponent_name }}
                                    {% else %}
                                        {% set is_p1 = match.player1.id == user.uid %}
                                        {% set opponent = match.player2 if is_p1 else match.player1 %}
                                        You vs {{ opponent.username }}
                                    {% endif %}
                                </div>
                                <div class="game-score">
                                    {{ match.player1_score }} - {{ match.player2_score }}
                                    {% if match.tournament_name %}
                                        <div class="badge badge-tournament">üèÜ {{ match.tournament_name }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p>No recent games to display.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Right Column: Competition Stack #}
            <div class="dashboard-column-right">
                <div class="competition-stack">
                    {# Section: Active Tournaments & Invites List #}
                    {% if active_tournaments or pending_tournament_invites %}
                        {# Render Invites as cards within the stack too #}
                        {% for invite in pending_tournament_invites %}
                            <div class="competition-card tournament-invite-card">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div class="ranking-group-name">{{ invite.name }}</div>
                                        <div class="text-muted small">
                                            {{ invite.date_display or invite.date }} ‚Ä¢ {{ invite.location or 'Online' }}
                                        </div>
                                    </div>
                                    <span class="badge badge-upcoming">INVITED</span>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 10px;">
                                    <form action="{{ url_for('tournament.accept_invite', tournament_id=invite.id) }}" method="post" style="flex: 1;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm" style="width: 100%; text-transform: none; font-size: 0.8rem;">Accept</button>
                                    </form>
                                    <form action="{{ url_for('tournament.decline_invite', tournament_id=invite.id) }}" method="post" style="flex: 1;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-sm btn-danger" style="width: 100%; text-transform: none; font-size: 0.8rem;">Decline</button>
                                    </form>
                                </div>
                                <a href="{{ url_for('tournament.view_tournament', tournament_id=invite.id) }}" class="btn btn-sm" style="width: 100%; margin-top: 8px; background: none; border: 1px solid var(--border-color); color: var(--text-color); text-transform: none; font-size: 0.8rem;">View Lobby</a>
                            </div>
                        {% endfor %}

                        {% for tournament in active_tournaments %}
                            <a href="{{ url_for('tournament.view_tournament', tournament_id=tournament.id) }}" class="competition-card active-tournament-card">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div class="ranking-group-name">{{ tournament.name }}</div>
                                        <div class="text-muted small">
                                            {{ tournament.date_display }} ‚Ä¢ {{ tournament.location or 'Online' }}
                                        </div>
                                    </div>
                                    {% if tournament.status == 'Active' %}
                                        <span class="badge badge-live">LIVE</span>
                                    {% else %}
                                        <span class="badge badge-upcoming">Upcoming</span>
                                    {% endif %}
                                </div>
                                <span class="btn btn-sm" style="margin-top: 10px; width: 100%; display: block;">Enter Lobby</span>
                            </a>
                        {% endfor %}
                    {% endif %}

                    {# Section: My Groups #}
                    <div class="card" style="padding: 16px;">
                        <h3 style="margin-top: 0; margin-bottom: 16px;">My Groups</h3>
                        {% for ranking in group_rankings %}
                            <a href="{{ url_for('group.view_group', group_id=ranking.group_id) }}" class="ranking-card">
                                <div class="ranking-card-top">
                                    <span class="ranking-group-name">{{ ranking.group_name }}</span>
                                    <span class="rank-badge-small">#{{ ranking.rank or '?' }}</span>
                                </div>
                                <div class="ranking-details">
                                    {% if ranking.rank == 1 %}
                                        Reigning Champion üëë
                                    {% elif ranking.rank and ranking.rank > 1 %}
                                        <span class="overtake-value">{{ "%.1f"|format(ranking.points_to_overtake) }}</span> pts to overtake <strong>{{ ranking.player_above }}</strong>
                                    {% else %}
                                        No rank yet
                                    {% endif %}
                                </div>
                                <div class="form-dots-row">
                                    {% for result in ranking.form %}
                                        <span class="form-dot-small {{ result }}"></span>
                                    {% endfor %}
                                </div>
                            </a>
                        {% else %}
                            <p class="text-muted">You are not a member of any groups.</p>
                        {% endfor %}
                    </div>

                    {# Section: Past Tournaments #}
                    <div class="card" style="padding: 16px;">
                        <h3 style="margin-top: 0; margin-bottom: 12px;">Past Tournaments</h3>
                        <div class="past-tournaments-list">
                            {% for tournament in past_tournaments %}
                                <div class="past-tournament-row">
                                    <div class="past-tournament-info">
                                        <strong>{{ tournament.name }}</strong><br>
                                        <small class="text-muted">{{ tournament.date_display }}</small>
                                    </div>
                                    <div class="past-tournament-winner">
                                        Winner: {{ tournament.winner_name }}
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-muted">No past tournaments.</p>
                            {% endfor %}
                        </div>
                    </div>

                    {# Section: Social (Friends) #}
                    <div class="card" style="padding: 16px;">
                        <h3 style="margin-top: 0; margin-bottom: 16px;">Social</h3>
                        {% if requests %}
                            <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Friend Requests</h4>
                            <div class="table-container" style="box-shadow: none; border: 1px solid var(--border-color); margin-bottom: 16px; border-radius: 4px;">
                                <table class="table responsive-table" style="margin-top: 0;">
                                    <tbody>
                                        {% for request in requests %}
                                            <tr>
                                                <td style="padding: 8px;">
                                                    <a href="{{ url_for('user.view_user', user_id=request.id) }}" style="font-size: 0.85rem;">{{ request.username }}</a>
                                                </td>
                                                <td style="padding: 8px; text-align: right;">
                                                    <form action="{{ url_for('user.accept_friend_request', friend_id=request.id) }}" method="post" style="display: inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-sm" style="padding: 4px 8px; font-size: 0.75rem; width: auto; text-transform: none;">Accept</button>
                                                    </form>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}

                        <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Your Friends</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            {% for friend in friends[:10] %}
                                <a href="{{ url_for('user.view_user', user_id=friend.id) }}" title="{{ friend.username }}">
                                    <img src="{{ friend | avatar_url }}" alt="{{ friend.username }}" class="profile-picture-thumbnail" style="width: 32px; height: 32px; margin: 0;">
                                </a>
                            {% else %}
                                <p class="text-muted small">No friends yet.</p>
                            {% endfor %}
                            {% if friends|length > 10 %}
                                <a href="{{ url_for('user.view_community') }}" class="text-muted small" style="align-self: center;">+{{ friends|length - 10 }} more</a>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('user.view_community') }}" class="btn btn-sm btn-outline" style="width: 100%; margin-top: 12px; background: none; border: 1px solid var(--border-color); color: var(--text-color); text-transform: none; font-size: 0.8rem;">Community Hub</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-edit-section" class="collapsible-section card" style="display: none;">
            <h3>Profile Information</h3>
            <form method="post" action="{{ url_for('user.dashboard') }}" enctype="multipart/form-data" class="profile-form">
                {{ form.hidden_tag() }}
                <div class="profile-header">
                    <img src="{{ user.avatar_url }}" alt="Profile Picture" class="profile-picture avatar" id="profile-picture-img">
                    <div class="form-group profile-picture-group">
                        {{ form.profile_picture(class="form-control", accept="image/*") }}
                    </div>
                </div>
                <h4 id="user-username">@{{ user.username }}</h4>
                <p><strong>Email:</strong> <span id="user-email">{{ user.email }}</span></p>

                <div class="form-group">
                    {{ form.dupr_rating.label(for="dupr_rating_input") }}
                    {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                </div>

                <div class="form-group dark-mode-group">
                    {{ form.dark_mode.label }}
                    <label class="switch">
                        {{ form.dark_mode() }}
                        <span class="slider round"></span>
                    </label>
                </div>

                <a href="{{ url_for('user.edit_profile') }}" class="btn">Edit Username and Password</a>
                {{ form.submit(class="btn") }}
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview profile picture
    const profilePictureInput = document.querySelector('input[name="profile_picture"]');
    const profilePictureImg = document.getElementById('profile-picture-img');

    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePictureImg.src = e.target.result;
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    // Toggle for the profile edit section
    const editProfileToggle = document.getElementById('edit-profile-toggle');
    const profileEditSection = document.getElementById('profile-edit-section');

    if (editProfileToggle) {
        editProfileToggle.addEventListener('click', function() {
            const isHidden = profileEditSection.style.display === 'none';
            profileEditSection.style.display = isHidden ? 'block' : 'none';
        });
    }
});
</script>
{% endblock %}
