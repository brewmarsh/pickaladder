{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Dashboard</h1>
        <p>Welcome, <span id="user-name">...</span>!</p>
    </div>

    <div id="dashboard-content" style="display: none;">
        <div class="grid-container">
            <div class="card">
                <h3>Profile Information</h3>
                <div class="profile-header" style="margin-bottom: 20px;">
                    <img src="" alt="Profile Picture" class="profile-picture" id="profile-picture-img">
                    <h4 id="user-username"></h4>
                </div>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>DUPR Rating:</strong> <span id="user-dupr"></span></p>

                <hr>
                <h4 style="margin-top: 20px;">Update Profile</h4>
                <form method="post" action="{{ url_for('user.update_profile') }}" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        {{ form.dupr_rating.label }}
                        {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                    </div>
                    <div class="form-group">
                        {{ form.profile_picture.label }}
                        {{ form.profile_picture(class="form-control") }}
                    </div>
                    <div class="form-group">
                        {{ form.dark_mode.label }}
                        {{ form.dark_mode() }}
                    </div>
                    {{ form.submit(class="btn") }}
                </form>
            </div>

            <div class="card">
                <h3>Friend Requests</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="friend-requests-body">
                            <!-- Friend requests will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 20px;">Your Friends</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>DUPR Rating</th>
                            </tr>
                        </thead>
                        <tbody id="friends-body">
                            <!-- Friends will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 20px;">My Group Rankings</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Group Name</th>
                                <th>Your Rank</th>
                            </tr>
                        </thead>
                        <tbody id="group-rankings-body">
                            <!-- Group rankings will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="header-with-button">
                <h3>Your Matches</h3>
                <a href="{{ url_for('match.create_match') }}" class="btn">Record a Match</a>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="matches-body">
                        <!-- Matches will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const dashboardContent = document.getElementById('dashboard-content');

    // URLs that will be used in the templates
    const urls = {
        view_user: (userId) => `/user/${userId}`,
        view_group: (groupId) => `/group/${groupId}`,
        accept_request: (friendId) => `/user/accept_friend_request/${friendId}`,
        decline_request: (friendId) => `/user/decline_friend_request/${friendId}`,
        profile_picture: (userId) => `/user/profile_picture/${userId}`
    };

    function renderUserInfo(user) {
        document.getElementById('user-name').textContent = user.name || 'User';
        document.getElementById('user-username').textContent = `@${user.username}`;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-dupr').textContent = user.dupr_rating || 'Not set';
        document.getElementById('profile-picture-img').src = urls.profile_picture(user.id);
        // Also populate the value in the update form
        document.getElementById('dupr_rating_input').value = user.dupr_rating || '';
    }

    function renderTable(tbodyId, items, rowTemplate, noDataMessage) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = ''; // Clear existing content
        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="100%">${noDataMessage}</td></tr>`;
            return;
        }
        items.forEach(item => {
            tbody.insertAdjacentHTML('beforeend', rowTemplate(item));
        });
    }

    const requestRowTemplate = (request) => `
        <tr>
            <td>
                <img src="${request.thumbnail_url}" alt="${request.username}'s thumbnail" class="profile-picture-thumbnail" style="vertical-align: middle; margin-right: 10px;">
                <a href="${urls.view_user(request.id)}">${request.username}</a>
            </td>
            <td style="text-align: right;">
                <a href="${urls.accept_request(request.id)}" class="btn">Accept</a>
                <a href="${urls.decline_request(request.id)}" class="btn btn-danger">Decline</a>
            </td>
        </tr>
    `;

    const friendRowTemplate = (friend) => `
        <tr>
            <td><a href="${urls.view_user(friend.id)}">${friend.username}</a></td>
            <td>${friend.dupr_rating || 'N/A'}</td>
        </tr>
    `;

    const matchRowTemplate = (match) => `
        <tr class="clickable-row" data-href="/match/${match.id}">
            <td>${match.date || 'N/A'}</td>
            <td><a href="${urls.view_user(match.opponent_id)}">${match.opponent_username}</a></td>
            <td>${match.user_score} - ${match.opponent_score}</td>
        </tr>
    `;

    const groupRankingRowTemplate = (ranking) => `
        <tr>
            <td><a href="${urls.view_group(ranking.group_id)}">${ranking.group_name}</a></td>
            <td>${ranking.rank}</td>
        </tr>
    `;

    fetch('/user/api/dashboard')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            renderUserInfo(data.user);
            renderTable('friend-requests-body', data.requests, requestRowTemplate, 'No pending friend requests.');
            renderTable('friends-body', data.friends, friendRowTemplate, 'You have no friends yet.');
            renderTable('matches-body', data.matches, matchRowTemplate, 'You have no match history.');
            renderTable('group-rankings-body', data.group_rankings, groupRankingRowTemplate, 'You are not a member of any groups.');

            // Hide loader and show content
            loader.style.display = 'none';
            dashboardContent.style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching dashboard data:', error);
            loader.innerHTML = '<p class="alert alert-danger">Could not load dashboard data. Please try again later.</p>';
        });
});
</script>
{% endblock %}
