{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
    <div id="dashboard-content">
        <div class="hero-stats-card">
            <button id="edit-profile-toggle" class="btn-edit-gear" title="Edit Profile">‚öôÔ∏è</button>
            <div class="hero-left-panel">
                 <img id="hero-profile-img" src="{{ user | avatar_url }}" alt="Profile Picture" class="profile-picture-large">
                 <div class="hero-name-and-edit">
                    <h2 id="hero-username-text">{{ user.name if user.name else user.username }}</h2>
                 </div>
            </div>
            <div class="hero-right-panel">
                <div id="vanity-stats-container" class="vanity-stats-container">
                    <div class="vanity-stat">
                        <div class="stat-value">{{ stats.total_games }}</div>
                        <div class="stat-label text-muted">Total Matches</div>
                    </div>
                    <div class="vanity-stat">
                        <div class="stat-value">{{ stats.win_rate | round | int }}%</div>
                        <div class="stat-label text-muted">Win %</div>
                    </div>
                    <div class="vanity-stat">
                        <div class="stat-value">{{ stats.current_streak }}{{ stats.streak_type if stats.total_games > 0 else 'N/A' }}</div>
                        <div class="stat-label text-muted">Current Streak</div>
                    </div>
                </div>
                <a href="{{ url_for('match.record_match') }}" class="btn btn-primary">Record a Match</a>
            </div>
        </div>
        <div class="dashboard-columns">
            <div class="dashboard-column-left">
                <div class="card">
                    <div class="header-with-button">
                        <h3>Recent Activity</h3>
                    </div>
                    <div id="latest-games-feed">
                        {% for match in matches %}
                            <div class="game-card {{ 'game-won' if match.user_result == 'win' else 'game-lost' }}">
                                <div class="game-date">
                                    {% if match.date and match.date != 'N/A' %}
                                        {% if match.date is string %}
                                            {{ match.date }}
                                        {% else %}
                                            {{ match.date.strftime('%b %d, %Y') }}
                                        {% endif %}
                                    {% else %}
                                        Date N/A
                                    {% endif %}
                                </div>
                                <div class="game-opponent">
                                    {% if match.match_type == 'doubles' %}
                                        {% set in_team1 = user.uid in match.player1|map(attribute='id') %}
                                        {% if in_team1 %}
                                            {% set partner = match.player1[1] if match.player1[0].id == user.uid else match.player1[0] %}
                                            {% set opponent_name = match.team2_name %}
                                        {% else %}
                                            {% set partner = match.player2[1] if match.player2[0].id == user.uid else match.player2[0] %}
                                            {% set opponent_name = match.team1_name %}
                                        {% endif %}
                                        (You & {{ partner.username }}) vs {{ opponent_name }}
                                    {% else %}
                                        {% set is_p1 = match.player1.id == user.uid %}
                                        {% set opponent = match.player2 if is_p1 else match.player1 %}
                                        You vs {{ opponent.username }}
                                    {% endif %}
                                </div>
                                <div class="game-score">
                                    {{ match.player1_score }} - {{ match.player2_score }}
                                    {% if match.tournament_name %}
                                        <div class="badge badge-tournament">üèÜ {{ match.tournament_name }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p>No recent games to display.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="dashboard-column-right">
                {% if pending_tournament_invites %}
                    <div class="card" style="margin-bottom: 24px; border-left: 6px solid var(--primary-brand);">
                        <h3>Tournament Invites</h3>
                        <div class="table-container">
                            <table class="table responsive-table">
                                <thead>
                                    <tr>
                                        <th>Tournament</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invite in pending_tournament_invites %}
                                        <tr>
                                            <td data-label="Tournament">
                                                <a href="{{ url_for('tournament.view_tournament', tournament_id=invite.id) }}"><strong>{{ invite.name }}</strong></a>
                                                <br><small class="text-muted">{{ invite.date }}</small>
                                            </td>
                                            <td data-label="Actions">
                                                <div style="display: flex; gap: 5px;">
                                                    <form action="{{ url_for('tournament.accept_invite', tournament_id=invite.id) }}" method="post" style="display: inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn" style="padding: 8px 12px; font-size: 12px;">Accept</button>
                                                    </form>
                                                    <form action="{{ url_for('tournament.decline_invite', tournament_id=invite.id) }}" method="post" style="display: inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;">Decline</button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                <div class="card">
                    <h3>Friend Requests</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in requests %}
                                    <tr>
                                        <td data-label="Username">
                                            <img src="{{ request | avatar_url }}" alt="{{ request.username }}'s thumbnail" class="profile-picture-thumbnail avatar" style="vertical-align: middle; margin-right: 10px;">
                                            <a href="{{ url_for('user.view_user', user_id=request.id) }}">{{ request.username }}</a>
                                        </td>
                                        <td data-label="Actions" style="text-align: right;">
                                            <form action="{{ url_for('user.accept_friend_request', friend_id=request.id) }}" method="post" style="display: inline;">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn">Accept</button>
                                            </form>
                                            <form action="{{ url_for('user.decline_friend_request', friend_id=request.id) }}" method="post" style="display: inline;">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-danger">Decline</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="100%">No pending friend requests.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">Your Friends</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>DUPR Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for friend in friends %}
                                    <tr>
                                        <td data-label="Username">
                                            <img src="{{ friend | avatar_url }}" alt="{{ friend.username }}'s thumbnail" class="profile-picture-thumbnail avatar" style="vertical-align: middle; margin-right: 10px;">
                                            <a href="{{ url_for('user.view_user', user_id=friend.id) }}">{{ friend.username }}</a>
                                        </td>
                                        <td data-label="DUPR Rating">{{ friend.duprRating or 'N/A' }}</td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="100%">You have no friends yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">My Groups</h3>
                    <div>
                        {% for ranking in group_rankings %}
                            <a href="{{ url_for('group.view_group', group_id=ranking.group_id) }}" class="group-ranking-card">
                                <div class="group-ranking-card-header">
                                    <span class="group-name">{{ ranking.group_name }}</span>
                                    <span class="group-rank">Rank: {{ ranking.rank or 'N/A' }}</span>
                                </div>
                                <div class="group-ranking-card-body">
                                    {% if ranking.rank == 1 %}
                                        <div class="rank-display">üëë</div><div class="rank-text">Reigning Champion</div>
                                    {% elif ranking.rank and ranking.rank > 1 %}
                                        <div class="points-to-overtake">
                                            <strong>{{ "%.2f"|format(ranking.points_to_overtake) }}</strong>
                                            <span class="points-label">points to overtake <strong>{{ ranking.player_above }}</strong></span>
                                        </div>
                                    {% else %}
                                        <div class="rank-display">-</div><div class="rank-text">No rank yet</div>
                                    {% endif %}
                                </div>
                                <div class="group-ranking-card-footer">
                                    <span class="form-preview-label">Form:</span>
                                    <div class="form-preview">
                                        {% for result in ranking.form %}
                                            <span class="form-indicator {{ result }}"></span>
                                        {% else %}
                                            No recent matches
                                        {% endfor %}
                                    </div>
                                </div>
                            </a>
                        {% else %}
                            <p>You are not a member of any groups.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-edit-section" class="collapsible-section card" style="display: none;">
            <h3>Profile Information</h3>
            <form method="post" action="{{ url_for('user.dashboard') }}" enctype="multipart/form-data" class="profile-form">
                {{ form.hidden_tag() }}
                <div class="profile-header">
                    <img src="{{ user.avatar_url }}" alt="Profile Picture" class="profile-picture avatar" id="profile-picture-img">
                    <div class="form-group profile-picture-group">
                        {{ form.profile_picture(class="form-control", accept="image/*") }}
                    </div>
                </div>
                <h4 id="user-username">@{{ user.username }}</h4>
                <p><strong>Email:</strong> <span id="user-email">{{ user.email }}</span></p>

                <div class="form-group">
                    {{ form.dupr_rating.label(for="dupr_rating_input") }}
                    {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                </div>

                <div class="form-group dark-mode-group">
                    {{ form.dark_mode.label }}
                    <label class="switch">
                        {{ form.dark_mode() }}
                        <span class="slider round"></span>
                    </label>
                </div>

                <a href="{{ url_for('user.edit_profile') }}" class="btn">Edit Username and Password</a>
                {{ form.submit(class="btn") }}
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview profile picture
    const profilePictureInput = document.querySelector('input[name="profile_picture"]');
    const profilePictureImg = document.getElementById('profile-picture-img');

    profilePictureInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePictureImg.src = e.target.result;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Toggle for the profile edit section
    const editProfileToggle = document.getElementById('edit-profile-toggle');
    const profileEditSection = document.getElementById('profile-edit-section');

    editProfileToggle.addEventListener('click', function() {
        const isHidden = profileEditSection.style.display === 'none';
        profileEditSection.style.display = isHidden ? 'block' : 'none';
    });
});
</script>
{% endblock %}
