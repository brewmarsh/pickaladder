{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
    <div id="dashboard-content" style="display: none;">
        <div class="hero-stats-card">
            <div class="hero-left-panel">
                 <img id="hero-profile-img" src="" alt="Profile Picture" class="profile-picture-large">
                 <div class="hero-name-and-edit">
                    <h2 id="hero-username-text"></h2>
                    <button id="edit-profile-toggle" class="btn btn-sm">‚öôÔ∏è Edit Profile</button>
                 </div>
            </div>
            <div class="hero-right-panel">
                <div id="vanity-stats-container">
                    <!-- Stats go here -->
                </div>
                <a href="{{ url_for('match.record_match') }}" class="btn">Record a Match</a>
            </div>
        </div>
        <div class="dashboard-columns">
            <div class="dashboard-column-left">
                <div class="card">
                    <div class="header-with-button">
                        <h3>Recent Activity</h3>
                    </div>
                    <div id="latest-games-feed">
                        <!-- Game cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <div class="dashboard-column-right">
                <div class="card">
                    <h3>Friend Requests</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="friend-requests-body">
                                <!-- Friend requests will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">Your Friends</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>DUPR Rating</th>
                                </tr>
                            </thead>
                            <tbody id="friends-body">
                                <!-- Friends will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">My Groups</h3>
                    <div id="group-rankings-container">
                        <!-- Group ranking cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-edit-section" class="collapsible-section card" style="display: none;">
            <h3>Profile Information</h3>
            <form method="post" action="{{ url_for('user.dashboard') }}" enctype="multipart/form-data" class="profile-form">
                {{ form.hidden_tag() }}
                <div class="profile-header">
                    <img src="{{ user.avatar_url }}" alt="Profile Picture" class="profile-picture avatar" id="profile-picture-img">
                    <div class="form-group profile-picture-group">
                        {{ form.profile_picture(class="form-control", accept="image/*") }}
                    </div>
                </div>
                <h4 id="user-username"></h4>
                <p><strong>Email:</strong> <span id="user-email"></span></p>

                <div class="form-group">
                    {{ form.dupr_rating.label(for="dupr_rating_input") }}
                    {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                </div>

                <div class="form-group dark-mode-group">
                    {{ form.dark_mode.label }}
                    <label class="switch">
                        {{ form.dark_mode() }}
                        <span class="slider round"></span>
                    </label>
                </div>

                <a href="{{ url_for('user.edit_profile') }}" class="btn">Edit Username and Password</a>
                {{ form.submit(class="btn") }}
            </form>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const dashboardContent = document.getElementById('dashboard-content');

    // URLs that will be used in the templates
    const urls = {
        view_user: (userId) => `/user/${userId}`,
        view_group: (groupId) => `/group/${groupId}`,
        accept_request: (friendId) => `/user/accept_friend_request/${friendId}`,
        decline_request: (friendId) => `/user/decline_friend_request/${friendId}`,
        profile_picture: (userId) => `/user/profile_picture/${userId}`
    };

    function renderUserInfo(user) {
        document.getElementById('user-username').textContent = `@${user.username}`;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('dupr_rating_input').value = user.duprRating || '';
        document.querySelector('input[name="dark_mode"]').checked = user.dark_mode;
    }

    function renderHeroStats(user, stats) {
        const seed = user.uid || user.id || "default";
        const diceBearUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=2e7d32,ffc107,1976d2`;
        document.getElementById('hero-profile-img').src = user.profilePictureUrl || diceBearUrl;
        document.getElementById('hero-username-text').textContent = user.name || user.username;

        const statsContainer = document.getElementById('vanity-stats-container');
        statsContainer.innerHTML = `
            <div class="vanity-stat">
                <div class="stat-value">${stats.total_matches}</div>
                <div class="stat-label">Total Matches</div>
            </div>
            <div class="vanity-stat">
                <div class="stat-value">${stats.win_percentage.toFixed(0)}%</div>
                <div class="stat-label">Win %</div>
            </div>
            <div class="vanity-stat">
                <div class="stat-value">${stats.current_streak}</div>
                <div class="stat-label">Current Streak</div>
            </div>
        `;
    }

    function renderTable(tbodyId, items, rowTemplate, noDataMessage) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = ''; // Clear existing content
        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="100%">${noDataMessage}</td></tr>`;
            return;
        }
        items.forEach(item => {
            tbody.insertAdjacentHTML('beforeend', rowTemplate(item));
        });
    }

    const csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const requestRowTemplate = (request) => {
        const seed = request.id || "default";
        const diceBearUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=2e7d32,ffc107,1976d2`;
        const avatarUrl = request.thumbnail_url || request.profilePictureUrl || diceBearUrl;
        return `
        <tr>
            <td data-label="Username">
                <img src="${avatarUrl}" alt="${request.username}'s thumbnail" class="profile-picture-thumbnail avatar" style="vertical-align: middle; margin-right: 10px;">
                <a href="${urls.view_user(request.id)}">${request.username}</a>
            </td>
            <td data-label="Actions" style="text-align: right;">
                <form action="${urls.accept_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn">Accept</button>
                </form>
                <form action="${urls.decline_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn btn-danger">Decline</button>
                </form>
            </td>
        </tr>
    `;
    };

    const friendRowTemplate = (friend) => `
        <tr>
            <td data-label="Username"><a href="${urls.view_user(friend.id)}">${friend.username}</a></td>
            <td data-label="DUPR Rating">${friend.dupr_rating || 'N/A'}</td>
        </tr>
    `;

    function renderGroupRankings(rankings) {
        const container = document.getElementById('group-rankings-container');
        if (rankings.length === 0) {
            container.innerHTML = '<p>You are not a member of any groups.</p>';
            return;
        }

        rankings.forEach(ranking => {
            let rankContent;
            if (ranking.rank === 1) {
                rankContent = `<div class="rank-display">üëë</div><div class="rank-text">Reigning Champion</div>`;
            } else if (ranking.rank > 1) {
                rankContent = `
                    <div class="points-to-overtake">
                        <strong>${ranking.points_to_overtake.toFixed(2)}</strong>
                        <span class="points-label">points to overtake <strong>${ranking.player_above}</strong></span>
                    </div>
                `;
            } else {
                 rankContent = `<div class="rank-display">-</div><div class="rank-text">No rank yet</div>`;
            }

            const formIndicators = (ranking.form || []).map(result =>
                `<span class="form-indicator ${result}"></span>`
            ).join('');

            const card = `
                <a href="${urls.view_group(ranking.group_id)}" class="group-ranking-card">
                    <div class="group-ranking-card-header">
                        <span class="group-name">${ranking.group_name}</span>
                        <span class="group-rank">Rank: ${ranking.rank || 'N/A'}</span>
                    </div>
                    <div class="group-ranking-card-body">
                        ${rankContent}
                    </div>
                    <div class="group-ranking-card-footer">
                        <span class="form-preview-label">Form:</span>
                        <div class="form-preview">
                            ${formIndicators || 'No recent matches'}
                        </div>
                    </div>
                </a>
            `;
            container.insertAdjacentHTML('beforeend', card);
        });
    }

    function formatMatchDate(dateString) {
        if (!dateString || dateString === 'N/A') {
            return 'Date N/A';
        }
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function renderLatestGames(matches) {
        const feed = document.getElementById('latest-games-feed');
        if (matches.length === 0) {
            feed.innerHTML = '<p>No recent games to display.</p>';
            return;
        }

        matches.forEach(match => {
            const isCloseScore = Math.abs(match.player1_score - match.player2_score) <= 2;
            const scoreClass = isCloseScore ? 'score-close' : '';

            const p1_winner = match.winner === 'player1' ? 'winner' : '';
            const p2_winner = match.winner === 'player2' ? 'winner' : '';

            let player1Display, player2Display;
            if (match.match_type === 'doubles') {
                player1Display = match.player1.map(p => `<a href="${urls.view_user(p.id)}" class="${p1_winner}">${p.username}</a>`).join(' & ');
                player2Display = match.player2.map(p => `<a href="${urls.view_user(p.id)}" class="${p2_winner}">${p.username}</a>`).join(' & ');
            } else {
                player1Display = `<a href="${urls.view_user(match.player1.id)}" class="${p1_winner}">${match.player1.username}</a>`;
                player2Display = `<a href="${urls.view_user(match.player2.id)}" class="${p2_winner}">${match.player2.username}</a>`;
            }

            const card = `
                <div class="game-card">
                    <div class="game-card-header">
                        <span>${formatMatchDate(match.date)}</span>
                    </div>
                    <div class="game-card-body">
                        <div class="team">${player1Display}</div>
                        <div class="score ${scoreClass}">${match.player1_score} - ${match.player2_score}</div>
                        <div class="team">${player2Display}</div>
                    </div>
                </div>
            `;
            feed.insertAdjacentHTML('beforeend', card);
        });
    }

    fetch('/user/api/dashboard')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            renderUserInfo(data.user);
            renderHeroStats(data.user, data.stats);
            renderTable('friend-requests-body', data.requests, requestRowTemplate, 'No pending friend requests.');
            renderTable('friends-body', data.friends, friendRowTemplate, 'You have no friends yet.');
            renderLatestGames(data.matches);
            renderGroupRankings(data.group_rankings);

            // Hide loader and show content
            loader.style.display = 'none';
            dashboardContent.style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching dashboard data:', error);
            loader.innerHTML = '<p class="alert alert-danger">Could not load dashboard data. Please try again later.</p>';
        });

    // Preview profile picture
    const profilePictureInput = document.querySelector('input[name="profile_picture"]');
    const profilePictureImg = document.getElementById('profile-picture-img');

    profilePictureInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePictureImg.src = e.target.result;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Toggle for the profile edit section
    const editProfileToggle = document.getElementById('edit-profile-toggle');
    const profileEditSection = document.getElementById('profile-edit-section');

    editProfileToggle.addEventListener('click', function() {
        const isHidden = profileEditSection.style.display === 'none';
        profileEditSection.style.display = isHidden ? 'block' : 'none';
    });
});
</script>
{% endblock %}
