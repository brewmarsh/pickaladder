{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
<div id="dashboard-content">
    {# Section: Tournament Invites (Top Priority Alert Banner) #}
    {% if pending_tournament_invites %}
    {% for tournament in pending_tournament_invites %}
    <div class="game-card tournament-invite-card"
        style="margin-bottom: 20px; border-left: 5px solid var(--accent-color);">
        <div style="flex: 2;">
            <div style="font-weight: 600; font-size: 1.1rem; color: var(--accent-color);">üèÜ You've been invited!</div>
            <div style="font-size: 1.2rem; font-weight: bold; margin-top: 4px;">{{ tournament.name }}</div>
            <div class="text-muted small">Starts {{ tournament.date }}</div>
        </div>
        <div style="flex: 1; display: flex; justify-content: flex-end; gap: 10px; align-items: center;">
            <form action="{{ url_for('tournament.accept_invite', tournament_id=tournament.id) }}" method="post"
                style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-volt" style="width: auto; margin: 0;">Accept</button>
            </form>
            <form action="{{ url_for('tournament.decline_invite', tournament_id=tournament.id) }}" method="post"
                style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger" style="width: auto; margin: 0;">Decline</button>
            </form>
        </div>
    </div>
    {% endfor %}
    {% endif %}

    <div class="hero-stats-card">
        <a href="{{ url_for('user.settings') }}" class="btn-edit-gear" title="Settings">‚öôÔ∏è</a>
        <div class="hero-left-panel">
            {# Resolved: Use the container pattern from main for better image fitting #}
            <div class="profile-picture-container avatar-xl">
                <img id="hero-profile-img" src="{{ user | avatar_url }}" alt="Profile Picture" class="profile-picture">
            </div>
        </div>
        <div class="hero-middle-panel text-center">
            <h2 id="hero-username-text" class="mb-2">{{ user.name if user.name else user.username }}</h2>
            <!-- Vanity Stats Row -->
            <div class="vanity-stats-container justify-content-center gap-4">
                <div class="vanity-stat">
                    <div class="stat-value fs-3 fw-bold">{{ stats.total_games }}</div>
                    <div class="stat-label text-muted small">Matches</div>
                </div>
                <div class="vanity-stat">
                    <div class="stat-value fs-3 fw-bold">{{ stats.win_rate | round | int }}%</div>
                    <div class="stat-label text-muted small">Win %</div>
                </div>
                <div class="vanity-stat">
                    <div class="stat-value fs-3 fw-bold text-volt">
                        {% if stats.total_games > 0 %}
                            {% if current_streak > 2 %}
                                üî• {{ current_streak }}
                            {% else %}
                                {{ current_streak }}
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="stat-label text-muted small">Streak</div>
                </div>
            </div>
        </div>
        <div class="hero-right-panel">
            <a href="{{ url_for('match.record_match') }}" class="btn btn-volt">Record a Match</a>
        </div>
    </div>

    {# Jump Back In Section #}
    {% if recent_opponents %}
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="card-header" style="border-bottom: none; margin-bottom: 0; padding-left: 0;">Jump Back In</h4>
            <div class="text-muted small mb-3">Recent Opponents</div>
            <div class="d-flex gap-3 mt-3">
                {% for opponent in recent_opponents %}
                <a href="{{ url_for('match.record_match', opponent_id=opponent.uid) }}" title="{{ opponent.name or opponent.username }}">
                    <img src="{{ opponent | avatar_url }}" alt="{{ opponent.username }}" class="avatar avatar-lg">
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="dashboard-columns">
        {# Left Column: Recent Activity #}
        <div class="dashboard-column-left">
            <div class="card">
                <div class="header-with-button">
                    <h3>Recent Activity</h3>
                </div>
                <div id="latest-games-feed">
                    {% if matches %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Matchup</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in matches %}
                            <tr>
                                <td class="text-muted" data-label="Date">
                                    {% if match.date and match.date != 'N/A' %}
                                    {{ match.date if match.date is string else match.date.strftime('%b %d') }}
                                    {% else %}
                                    Date N/A
                                    {% endif %}
                                </td>
                                <td data-label="Matchup">
                                    {% if match.match_type == 'doubles' %}
                                        {% set in_team1 = user.uid in match.player1|map(attribute='id') %}
                                        {% if in_team1 %}
                                            {% set partner = match.player1[1] if match.player1[0].id == user.uid else match.player1[0] %}
                                            {% set opponent_name = match.team2_name %}
                                            {% set user_score = match.player1_score %}
                                            {% set opp_score = match.player2_score %}
                                        {% else %}
                                            {% set partner = match.player2[1] if match.player2[0].id == user.uid else match.player2[0] %}
                                            {% set opponent_name = match.team1_name %}
                                            {% set user_score = match.player2_score %}
                                            {% set opp_score = match.player1_score %}
                                        {% endif %}
                                        <strong>You & {{ partner.username }}</strong> vs {{ opponent_name }}
                                    {% else %}
                                        {% set is_p1 = match.player1.id == user.uid %}
                                        {% if is_p1 %}
                                            {% set opponent = match.player2 %}
                                            {% set user_score = match.player1_score %}
                                            {% set opp_score = match.player2_score %}
                                        {% else %}
                                            {% set opponent = match.player1 %}
                                            {% set user_score = match.player2_score %}
                                            {% set opp_score = match.player1_score %}
                                        {% endif %}
                                        <strong>You</strong> vs {{ opponent.username }}
                                    {% endif %}
                                </td>
                                <td data-label="Result">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if match.user_result == 'win' %}
                                            <span class="badge badge-success">W</span>
                                            {% else %}
                                            <span class="badge badge-danger">L</span>
                                            {% endif %}
                                            {{ user_score }} - {{ opp_score }}
                                            {% if match.tournament_name %}
                                            <div class="text-muted small" style="margin-top: 4px;">üèÜ {{ match.tournament_name }}</div>
                                            {% endif %}
                                        </div>
                                        {% if (match.created_by == user.uid and not match.tournament_id) or user.isAdmin %}
                                        <a href="{{ url_for('match.edit_match', match_id=match.id) }}" class="text-muted" title="Edit Match">
                                            ‚úèÔ∏è
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted" style="padding: 20px; text-align: center;">No recent matches found.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Right Column: Competition Stack #}
        <div class="dashboard-column-right">
            <div class="competition-stack">
                {# Competitions Hub #}
                <div class="card card-compact" style="padding: 16px;">
                    <h3 style="margin-top: 0; margin-bottom: 16px;">Competitions</h3>
                    {% if not active_tournaments and not group_rankings and not past_tournaments %}
                    <div class="text-center p-5">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <h4>Find your squad</h4>
                        <p class="text-muted" style="margin-bottom: 24px;">Join a group or tournament to start competing and climb the ranks!</p>
                        <a href="{{ url_for('user.view_community') }}" class="btn btn-volt" style="width: auto;">Find a Group</a>
                    </div>
                    {% else %}
                    <div class="list-group list-group-flush">
                        {# Section 1: Active Tournaments (Top Priority) #}
                        {% for tournament in active_tournaments %}
                        <a href="{{ url_for('tournament.view_tournament', tournament_id=tournament.id) }}"
                            class="list-group-item list-group-item-action"
                            style="display: flex; align-items: center; border-left: 4px solid var(--accent-color); padding: 12px 16px; text-decoration: none; color: inherit; border-bottom: 1px solid var(--border-color);">
                            <span style="margin-right: 12px; font-size: 1.25rem;">üèÜ</span>
                            <div style="flex-grow: 1;">
                                <div class="fw-bold">{{ tournament.name }}</div>
                                <div class="text-muted small">{{ tournament.date_display or tournament.date }}</div>
                            </div>
                            <span class="badge badge-warning">Round 1 / {{ tournament.status }}</span>
                        </a>
                        {% endfor %}

                        {# Section 2: Groups (Ongoing) #}
                        {% for ranking in group_rankings %}
                        <a href="{{ url_for('group.view_group', group_id=ranking.group_id) }}"
                            class="list-group-item list-group-item-action"
                            style="display: flex; align-items: center; padding: 12px 16px; text-decoration: none; color: inherit; border-bottom: 1px solid var(--border-color);">
                            {% if ranking.group_image %}
                            <div class="profile-picture-container avatar-sm" style="margin-right: 12px;">
                                <img src="{{ ranking.group_image }}" alt="{{ ranking.group_name }}" class="profile-picture">
                            </div>
                            {% else %}
                            <span style="margin-right: 12px; font-size: 1.25rem;">üë•</span>
                            {% endif %}
                            <div style="flex-grow: 1;">
                                <div class="fw-bold">{{ ranking.group_name }}</div>
                                <div class="text-muted small">Rank #{{ ranking.rank or '?' }}</div>
                            </div>
                        </a>
                        {% endfor %}

                        {# Section 3: Past Tournaments (History) #}
                        {% for tournament in past_tournaments %}
                        <a href="{{ url_for('tournament.view_tournament', tournament_id=tournament.id) }}"
                            class="list-group-item list-group-item-action"
                            style="display: flex; align-items: center; padding: 12px 16px; text-decoration: none; color: inherit; border-bottom: 1px solid var(--border-color); opacity: 0.75;">
                            <span style="margin-right: 12px; font-size: 1.25rem;">üèÅ</span>
                            <div style="flex-grow: 1;">
                                <div class="fw-bold">{{ tournament.name }}</div>
                                <div class="text-muted small">Finished</div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {# Social Section #}
                <div class="card" style="padding: 16px;">
                    <h3 style="margin-top: 0; margin-bottom: 16px;">Social</h3>
                    {% if requests %}
                    <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Friend Requests</h4>
                    <div class="table-container"
                        style="box-shadow: none; border: 1px solid var(--border-color); margin-bottom: 16px; border-radius: 4px;">
                        <table class="table" style="margin-top: 0;">
                            <tbody>
                                {% for request in requests %}
                                <tr>
                                    <td style="padding: 8px;">
                                        <a href="{{ url_for('user.view_user', user_id=request.id) }}"
                                            style="font-size: 0.85rem;">{{ request.username }}</a>
                                    </td>
                                    <td style="padding: 8px; text-align: right;">
                                        <form action="{{ url_for('user.accept_request', requester_id=request.id) }}"
                                            method="post" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-volt btn-sm"
                                                style="padding: 4px 8px; font-size: 0.75rem; width: auto; text-transform: none;">Accept</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Your Friends</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for friend in friends[:10] %}
                        <a href="{{ url_for('user.view_user', user_id=friend.id) }}" title="{{ friend.username }}">
                            <img src="{{ friend | avatar_url }}" alt="{{ friend.username }}" class="avatar avatar-md">
                        </a>
                        {% else %}
                        <p class="text-muted small">No friends yet.</p>
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('user.view_community') }}" class="btn btn-sm btn-outline-primary"
                        style="width: 100%; margin-top: 12px; text-transform: none;">Community Hub</a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}