{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
    <div id="dashboard-content" style="display: none;">
        <div class="hero-stats-card">
            <div class="hero-left-panel">
                 <img id="hero-profile-img" src="" alt="Profile Picture" class="profile-picture-large">
                 <div class="hero-name-and-edit">
                    <h2 id="hero-username-text"></h2>
                    <button id="edit-profile-toggle" class="btn btn-sm">‚öôÔ∏è <span class="edit-profile-text">Edit Profile</span></button>
                 </div>
            </div>
            <div class="hero-right-panel">
                <div id="vanity-stats-container">
                    <!-- Stats go here -->
                </div>
                <a href="{{ url_for('match.record_match') }}" class="btn">Record a Match</a>
            </div>
        </div>
        <div class="dashboard-columns">
            <div class="dashboard-column-left">
                <div class="card">
                    <div class="header-with-button">
                        <h3>Recent Activity</h3>
                    </div>
                    <div id="latest-games-feed">
                        <!-- Game cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <div class="dashboard-column-right">
                <div class="card">
                    <h3>Friend Requests</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="friend-requests-body">
                                <!-- Friend requests will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">Your Friends</h3>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>DUPR Rating</th>
                                </tr>
                            </thead>
                            <tbody id="friends-body">
                                <!-- Friends will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 20px;">My Groups</h3>
                    <div id="group-rankings-container">
                        <!-- Group ranking cards will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-edit-section" class="collapsible-section card" style="display: none;">
            <h3>Profile Information</h3>
            <form method="post" action="{{ url_for('user.dashboard') }}" enctype="multipart/form-data" class="profile-form">
                {{ form.hidden_tag() }}
                <div class="profile-header">
                    <img src="{{ user.avatar_url }}" alt="Profile Picture" class="profile-picture avatar" id="profile-picture-img">
                    <div class="form-group profile-picture-group">
                        {{ form.profile_picture(class="form-control", accept="image/*") }}
                    </div>
                </div>
                <h4 id="user-username"></h4>
                <p><strong>Email:</strong> <span id="user-email"></span></p>

                <div class="form-group">
                    {{ form.dupr_rating.label(for="dupr_rating_input") }}
                    {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                </div>

                <div class="form-group dark-mode-group">
                    {{ form.dark_mode.label }}
                    <label class="switch">
                        {{ form.dark_mode() }}
                        <span class="slider round"></span>
                    </label>
                </div>

                <a href="{{ url_for('user.edit_profile') }}" class="btn">Edit Username and Password</a>
                {{ form.submit(class="btn") }}
            </form>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const dashboardContent = document.getElementById('dashboard-content');

    // URLs that will be used in the templates
    const urls = {
        view_user: (userId) => `/user/${userId}`,
        view_group: (groupId) => `/group/${groupId}`,
        accept_request: (friendId) => `/user/accept_friend_request/${friendId}`,
        decline_request: (friendId) => `/user/decline_friend_request/${friendId}`,
        profile_picture: (userId) => `/user/profile_picture/${userId}`
    };

    function renderUserInfo(user) {
        document.getElementById('user-username').textContent = `@${user.username}`;
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('dupr_rating_input').value = user.duprRating || '';
        document.querySelector('input[name="dark_mode"]').checked = user.dark_mode;
    }

    function renderHeroStats(user, stats) {
        const seed = user.uid || user.id || "default";
        const diceBearUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=2e7d32,ffc107,1976d2`;
        document.getElementById('hero-profile-img').src = user.profilePictureUrl || diceBearUrl;
        document.getElementById('hero-username-text').textContent = user.name || user.username;

        const statsContainer = document.getElementById('vanity-stats-container');
        statsContainer.innerHTML = `
            <div class="vanity-stat">
                <div class="stat-value">${stats.total_matches}</div>
                <div class="stat-label">Total Matches</div>
            </div>
            <div class="vanity-stat">
                <div class="stat-value">${stats.win_percentage.toFixed(0)}%</div>
                <div class="stat-label">Win %</div>
            </div>
            <div class="vanity-stat">
                <div class="stat-value">${stats.current_streak}</div>
                <div class="stat-label">Current Streak</div>
            </div>
        `;
    }

    function renderTable(tbodyId, items, rowTemplate, noDataMessage) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = ''; // Clear existing content
        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="100%">${noDataMessage}</td></tr>`;
            return;
        }
        items.forEach(item => {
            tbody.insertAdjacentHTML('beforeend', rowTemplate(item));
        });
    }

    const csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const requestRowTemplate = (request) => {
        const seed = request.id || "default";
        const diceBearUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&backgroundColor=2e7d32,ffc107,1976d2`;
        const avatarUrl = request.thumbnail_url || request.profilePictureUrl || diceBearUrl;
        return `
        <tr>
            <td data-label="Username">
                <img src="${avatarUrl}" alt="${request.username}'s thumbnail" class="profile-picture-thumbnail avatar" style="vertical-align: middle; margin-right: 10px;">
                <a href="${urls.view_user(request.id)}">${request.username}</a>
            </td>
            <td data-label="Actions" style="text-align: right;">
                <form action="${urls.accept_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn">Accept</button>
                </form>
                <form action="${urls.decline_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn btn-danger">Decline</button>
                </form>
            </td>
        </tr>
    `;
    };

    const friendRowTemplate = (friend) => `
        <tr>
            <td data-label="Username"><a href="${urls.view_user(friend.id)}">${friend.username}</a></td>
            <td data-label="DUPR Rating">${friend.dupr_rating || 'N/A'}</td>
        </tr>
    `;

    function renderGroupRankings(rankings) {
        const container = document.getElementById('group-rankings-container');
        if (rankings.length === 0) {
            container.innerHTML = '<p>You are not a member of any groups.</p>';
            return;
        }

        container.innerHTML = ''; // Clear existing content

        rankings.forEach(ranking => {
            let rankIcon = '';
            if (ranking.rank === 1) rankIcon = 'ü•á';
            else if (ranking.rank === 2) rankIcon = 'ü•à';
            else if (ranking.rank === 3) rankIcon = 'ü•â';
            else rankIcon = `<span class="text-muted" style="font-size: 0.9em;">#${ranking.rank || 'N/A'}</span>`;

            let trendIcon = '';
            if (ranking.rank_change > 0) trendIcon = '<span class="trend-arrow trend-up">‚Üë</span>';
            else if (ranking.rank_change < 0) trendIcon = '<span class="trend-arrow trend-down">‚Üì</span>';
            else if (ranking.rank_change === 'new') trendIcon = '<span class="trend-arrow trend-new">‚òÖ</span>';

            const card = `
                <a href="${urls.view_group(ranking.group_id)}" class="group-ranking-card">
                    <div class="group-info">
                        <div class="rank-medal">${rankIcon}</div>
                        <div class="group-name">${ranking.group_name}</div>
                    </div>
                    <div class="group-trend">
                        ${trendIcon}
                    </div>
                </a>
            `;
            container.insertAdjacentHTML('beforeend', card);
        });
    }

    function formatMatchDate(dateString) {
        if (!dateString || dateString === 'N/A') {
            return 'N/A';
        }
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });
    }

    function renderLatestGames(matches, currentUserId) {
        const feed = document.getElementById('latest-games-feed');
        if (matches.length === 0) {
            feed.innerHTML = '<p>No recent games to display.</p>';
            return;
        }

        feed.innerHTML = ''; // Clear feed

        matches.forEach(match => {
            const isTeam1 = (Array.isArray(match.player1) && match.player1.some(p => p.id === currentUserId)) ||
                          (!Array.isArray(match.player1) && match.player1.id === currentUserId);

            const myTeam = isTeam1 ? match.player1 : match.player2;
            const opponentTeam = isTeam1 ? match.player2 : match.player1;

            const myTeamName = isTeam1 ? (match.team1 && match.team1.name) : (match.team2 && match.team2.name);
            const opponentTeamName = isTeam1 ? (match.team2 && match.team2.name) : (match.team1 && match.team1.name);

            const formatTeamDisplay = (team, teamName, isMe) => {
                let displayName = '';
                if (teamName) {
                    displayName = teamName;
                } else if (Array.isArray(team)) {
                    displayName = team.map(p => p.username).join(' & ');
                } else {
                    displayName = team.username;
                }
                return isMe ? `<span class="match-user-bold">${displayName}</span>` : displayName;
            };

            const myDisplay = formatTeamDisplay(myTeam, myTeamName, true);
            const opponentDisplay = formatTeamDisplay(opponentTeam, opponentTeamName, false);

            const myScore = isTeam1 ? match.player1_score : match.player2_score;
            const opponentScore = isTeam1 ? match.player2_score : match.player1_score;

            const resultClass = match.user_result === 'win' ? 'game-won' : (match.user_result === 'loss' ? 'game-lost' : '');
            const upsetIcon = match.is_upset ? ' üî•' : '';

            const card = `
                <div class="game-card ${resultClass}">
                    <div class="game-date">${formatMatchDate(match.date)}</div>
                    <div class="game-matchup">
                        ${myDisplay} <span class="vs-text">vs</span> ${opponentDisplay}
                    </div>
                    <div class="game-score">
                        ${myScore}-${opponentScore}${upsetIcon}
                    </div>
                </div>
            `;
            feed.insertAdjacentHTML('beforeend', card);
        });
    }

    fetch('/user/api/dashboard')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const currentUserId = data.user.uid || data.user.id;
            renderUserInfo(data.user);
            renderHeroStats(data.user, data.stats);
            renderTable('friend-requests-body', data.requests, requestRowTemplate, 'No pending friend requests.');
            renderTable('friends-body', data.friends, friendRowTemplate, 'You have no friends yet.');
            renderLatestGames(data.matches, currentUserId);
            renderGroupRankings(data.group_rankings);

            // Hide loader and show content
            loader.style.display = 'none';
            dashboardContent.style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching dashboard data:', error);
            loader.innerHTML = '<p class="alert alert-danger">Could not load dashboard data. Please try again later.</p>';
        });

    // Preview profile picture
    const profilePictureInput = document.querySelector('input[name="profile_picture"]');
    const profilePictureImg = document.getElementById('profile-picture-img');

    profilePictureInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePictureImg.src = e.target.result;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Toggle for the profile edit section
    const editProfileToggle = document.getElementById('edit-profile-toggle');
    const profileEditSection = document.getElementById('profile-edit-section');

    editProfileToggle.addEventListener('click', function() {
        const isHidden = profileEditSection.style.display === 'none';
        profileEditSection.style.display = isHidden ? 'block' : 'none';
    });
});
</script>
{% endblock %}
