{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='toggle.css') }}">
{% endblock %}
{% block content %}
    <div id="dashboard-content" style="display: none;">
        <div class="grid-container">
            <div class="card">
                <h3>Profile Information</h3>
                <form method="post" action="{{ url_for('user.dashboard') }}" enctype="multipart/form-data" class="profile-form">
                    {{ form.hidden_tag() }}
                    <div class="profile-header">
                        <img src="{{ user.profilePictureUrl or url_for('static', filename='user_icon.png') }}" alt="Profile Picture" class="profile-picture" id="profile-picture-img">
                        <div class="form-group profile-picture-group">
                            {{ form.profile_picture(class="form-control", accept="image/*") }}
                        </div>
                    </div>
                    <h4 id="user-username"></h4>
                    <p><strong>Email:</strong> <span id="user-email"></span></p>

                    <div class="form-group">
                        {{ form.dupr_rating.label(for="dupr_rating_input") }}
                        {{ form.dupr_rating(class="form-control", id="dupr_rating_input") }}
                    </div>

                    <div class="form-group dark-mode-group">
                        {{ form.dark_mode.label }}
                        <label class="switch">
                            {{ form.dark_mode() }}
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <a href="{{ url_for('user.edit_profile') }}" class="btn">Edit Username and Password</a>
                    {{ form.submit(class="btn") }}
                </form>
            </div>

            <div class="card">
                <h3>Friend Requests</h3>
                <div class="table-container">
                    <table class="table responsive-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="friend-requests-body">
                            <!-- Friend requests will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 20px;">Your Friends</h3>
                <div class="table-container">
                    <table class="table responsive-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>DUPR Rating</th>
                            </tr>
                        </thead>
                        <tbody id="friends-body">
                            <!-- Friends will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 20px;">My Group Rankings</h3>
                <div class="table-container">
                    <table class="table responsive-table">
                        <thead>
                            <tr>
                                <th>Group Name</th>
                                <th>Your Rank</th>
                            </tr>
                        </thead>
                        <tbody id="group-rankings-body">
                            <!-- Group rankings will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="header-with-button">
                <h3>Your Matches</h3>
                <a href="{{ url_for('match.create_match') }}" class="btn">Record a Match</a>
            </div>
            <div class="table-container">
                <table class="table responsive-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="matches-body">
                        <!-- Matches will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loader = document.getElementById('loader');
    const dashboardContent = document.getElementById('dashboard-content');

    // URLs that will be used in the templates
    const urls = {
        view_user: (userId) => `/user/${userId}`,
        view_group: (groupId) => `/group/${groupId}`,
        accept_request: (friendId) => `/user/accept_friend_request/${friendId}`,
        decline_request: (friendId) => `/user/decline_friend_request/${friendId}`,
        profile_picture: (userId) => `/user/profile_picture/${userId}`
    };

    function renderUserInfo(user) {
        document.getElementById('user-username').textContent = `@${user.username}`;
        document.getElementById('user-email').textContent = user.email;
        // Also populate the value in the update form
        document.getElementById('dupr_rating_input').value = user.duprRating || '';
        document.querySelector('input[name="dark_mode"]').checked = user.dark_mode;
    }

    function renderTable(tbodyId, items, rowTemplate, noDataMessage) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = ''; // Clear existing content
        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="100%">${noDataMessage}</td></tr>`;
            return;
        }
        items.forEach(item => {
            tbody.insertAdjacentHTML('beforeend', rowTemplate(item));
        });
    }

    const csrf_token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const requestRowTemplate = (request) => `
        <tr>
            <td data-label="Username">
                <img src="${request.thumbnail_url}" alt="${request.username}'s thumbnail" class="profile-picture-thumbnail" style="vertical-align: middle; margin-right: 10px;">
                <a href="${urls.view_user(request.id)}">${request.username}</a>
            </td>
            <td data-label="Actions" style="text-align: right;">
                <form action="${urls.accept_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn">Accept</button>
                </form>
                <form action="${urls.decline_request(request.id)}" method="post" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="${csrf_token}">
                    <button type="submit" class="btn btn-danger">Decline</button>
                </form>
            </td>
        </tr>
    `;

    const friendRowTemplate = (friend) => `
        <tr>
            <td data-label="Username"><a href="${urls.view_user(friend.id)}">${friend.username}</a></td>
            <td data-label="DUPR Rating">${friend.dupr_rating || 'N/A'}</td>
        </tr>
    `;

    const matchRowTemplate = (match) => `
        <tr class="clickable-row" data-href="/match/${match.id}">
            <td data-label="Date">${match.date || 'N/A'}</td>
            <td data-label="Opponent">
                <a href="${urls.view_user(match.opponent_id)}">${match.opponent_username}</a>
                ${match.is_group_match ? '<span title="Group Match" style="margin-left: 5px; cursor: help;">ðŸ‘¥</span>' : ''}
            </td>
            <td data-label="Score">${match.user_score} - ${match.opponent_score}</td>
        </tr>
    `;

    const groupRankingRowTemplate = (ranking) => `
        <tr>
            <td data-label="Group Name"><a href="${urls.view_group(ranking.group_id)}">${ranking.group_name}</a></td>
            <td data-label="Your Rank">${ranking.rank}</td>
        </tr>
    `;

    fetch('/user/api/dashboard')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            renderUserInfo(data.user);
            renderTable('friend-requests-body', data.requests, requestRowTemplate, 'No pending friend requests.');
            renderTable('friends-body', data.friends, friendRowTemplate, 'You have no friends yet.');
            renderTable('matches-body', data.matches, matchRowTemplate, 'You have no match history.');
            renderTable('group-rankings-body', data.group_rankings, groupRankingRowTemplate, 'You are not a member of any groups.');

            // Hide loader and show content
            loader.style.display = 'none';
            dashboardContent.style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching dashboard data:', error);
            loader.innerHTML = '<p class="alert alert-danger">Could not load dashboard data. Please try again later.</p>';
        });

    // Preview profile picture
    const profilePictureInput = document.querySelector('input[name="profile_picture"]');
    const profilePictureImg = document.getElementById('profile-picture-img');

    profilePictureInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePictureImg.src = e.target.result;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });
});
</script>
{% endblock %}
