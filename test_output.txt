warning: No `requires-python` value found in the workspace. Defaulting to `>=3.12`.
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: base-url-2.1.0, flask-1.3.0, mock-3.15.1, Faker-40.4.0, playwright-0.7.2, anyio-4.12.1
collected 2 items / 1 deselected / 1 selected

tests/test_referral.py F                                                 [100%]

=================================== FAILURES ===================================
_______________________ test_attribution_on_registration _______________________

client = <FlaskClient <Flask 'pickaladder'>>
mock_db = <mockfirestore.client.MockFirestore object at 0x7f29e3e4a5d0>

    @pytest.mark.usefixtures("apply_global_patches")
    def test_attribution_on_registration(client: Any, mock_db: MockFirestore) -> None:
        """Test that referral is attributed during registration."""
        # Setup referrer in Firestore
        mock_db.collection("users").document(REFERRER_ID).set({"username": "referrer"})

        # Set referrer in session
        with client.session_transaction() as sess:
            sess["referrer_id"] = REFERRER_ID

        # Mock user creation in Auth
        with (
            patch("firebase_admin.auth.create_user") as mock_create,
            patch("firebase_admin.auth.generate_email_verification_link") as mock_gen,
            patch("pickaladder.auth.routes.send_email"),
            patch("pickaladder.auth.routes.UserService.merge_ghost_user", return_value=False),
        ):
            mock_create.return_value = MagicMock(uid="new_user_uid")
            mock_gen.return_value = "http://verify"

            # Post registration (CSRF disabled in tests)
            response = client.post(
                "/auth/register",
                data={
                    "username": "uniqueuser123",
                    "email": "unique@example.com",
                    "password": MOCK_PASSWORD,
                    "confirm_password": MOCK_PASSWORD,
                    "name": "New User",
                },
                follow_redirects=True,
            )
            assert response.status_code == 200
>           assert b"Registration successful" in response.data
E           assert b'Registration successful' in b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=de...essage}`;\n                flashes.appendChild(flash);\n            });\n    });\n});\n</script>\n\n</body>\n\n</html>'
E            +  where b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=de...essage}`;\n                flashes.appendChild(flash);\n            });\n    });\n});\n</script>\n\n</body>\n\n</html>' = <WrapperTestResponse 14153 bytes [200 OK]>.data

tests/test_referral.py:89: AssertionError
=============================== warnings summary ===============================
tests/test_referral.py::test_attribution_on_registration
  /app/.venv/lib/python3.12/site-packages/mockfirestore/query.py:56: DeprecationWarning: Query.get is deprecated, please use Query.stream
    warnings.warn('Query.get is deprecated, please use Query.stream',

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_referral.py::test_attribution_on_registration - assert b'Re...
================== 1 failed, 1 deselected, 1 warning in 0.33s ==================
