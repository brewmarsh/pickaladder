============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: flask-1.3.0, Faker-40.4.0, anyio-4.12.1
collected 3 items

tests/test_match.py .F.                                                  [100%]

=================================== FAILURES ===================================
________________ MatchRoutesFirebaseTestCase.test_record_match _________________

self = <tests.test_match.MatchRoutesFirebaseTestCase testMethod=test_record_match>
mock_get_candidate_player_ids = <MagicMock name='get_candidate_player_ids' id='140061025666592'>

    @patch("pickaladder.match.routes.MatchService.get_candidate_player_ids")
    def test_record_match(self, mock_get_candidate_player_ids: MagicMock) -> None:
        """Test recording a new match."""
        mock_get_candidate_player_ids.return_value = {MOCK_OPPONENT_ID}
        self._set_session_user()

        mock_db = self.mock_firestore_service.client.return_value

        # Mock the db.get_all call that populates the form choices
        mock_user_snapshot = MagicMock()
        mock_user_snapshot.exists = True
        mock_user_snapshot.id = MOCK_USER_ID
        mock_user_snapshot.to_dict.return_value = MOCK_USER_DATA

        mock_opponent_snapshot = MagicMock()
        mock_opponent_snapshot.exists = True
        mock_opponent_snapshot.id = MOCK_OPPONENT_ID
        mock_opponent_snapshot.to_dict.return_value = MOCK_OPPONENT_DATA
        mock_db.get_all.return_value = [mock_user_snapshot, mock_opponent_snapshot]

        mock_matches_collection = mock_db.collection("matches")

        response = self.client.post(
            "/match/record",
            headers=self._get_auth_headers(),
            data={
                "player1": MOCK_USER_ID,
                "player2": MOCK_OPPONENT_ID,
                "player1_score": 11,
                "player2_score": 5,
                "match_date": datetime.date.today().isoformat(),
                "match_type": "singles",
            },
            follow_redirects=True,
        )
        self.assertEqual(response.status_code, 200)
>       self.assertIn(b"Match recorded successfully.", response.data)
E       AssertionError: b'Match recorded successfully.' not found in b'<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <meta name="csrf-token" content="ImEwZWVjZmNjMzk3MjBhYWZkZDdhZTBkNjU3NWQxNDNlOTg3NmJhNWUi.aYrHBA.rqR1abp34THmMGXfQ1Tvt3_BnXE">\n    <title>pickaladder - Record Match</title>\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link\n        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@300;400;500;600;700&display=swap"\n        rel="stylesheet">\n    <link rel="icon" href="/static/pickaladder_logo_64.png" type="image/png" sizes="64x64">\n    <link rel="icon" href="/static/pickaladder_logo_128.png" type="image/png"\n        sizes="128x128">\n    <link rel="icon" href="/static/pickaladder_logo_256.png" type="image/png"\n        sizes="256x256">\n    <link rel="icon" href="/static/pickaladder_logo_512.png" type="image/png"\n        sizes="512x512">\n    <link rel="stylesheet" href="/static/css/variables.css">\n    <link rel="stylesheet" href="/static/css/layout.css">\n    <link rel="stylesheet" href="/static/css/components.css">\n    <link rel="stylesheet" href="/static/style.css">\n    <link rel="stylesheet" href="/static/dark.css">\n    <link rel="stylesheet" href="/static/mobile.css">\n</head>\n\n<body >\n    <header class="header">\n    <div class="container">\n        <nav class="navbar">\n            <a href="/user/dashboard" class="navbar-brand" style="display: flex; align-items: center;">\n                <img src="/static/pickaladder_logo_64.png" alt="pickaladder logo"\n                    style="height: 24px; margin-right: 8px;">\n                pickaladder\n            </a>\n            <div class="navbar-menu">\n                \n                <a href="/user/dashboard"\n                    class="nav-link ">\xf0\x9f\x93\x88 Dashboard</a>\n                <a href="/user/community"\n                    class="nav-link "\n                    style="position: relative;">\n                    \xf0\x9f\x8c\x8d Community\n                    \n                </a>\n                <a href="/group/"\n                    class="nav-link ">\xf0\x9f\x91\xa8\xe2\x80\x8d\xf0\x9f\x91\xa9\xe2\x80\x8d\xf0\x9f\x91\xa7\xe2\x80\x8d\xf0\x9f\x91\xa6 Groups</a>\n                <a href="/tournaments/"\n                    class="nav-link "\n                    style="position: relative;">\n                    \xf0\x9f\x8e\xbe Tournaments\n                    \n                </a>\n                <a href="/match/leaderboard"\n                    class="nav-link ">\xf0\x9f\x8f\x86 Global Leaderboard</a>\n                \n            </div>\n            <div class="navbar-user-controls">\n                \n                <div class="dropdown">\n                    <button class="dropbtn">\n                        <img src="https://api.dicebear.com/9.x/avataaars/svg?seed=User" alt="Profile Picture" class="avatar avatar-sm"\n                            onerror="this.onerror=null;this.src=\'/static/user_icon.png\';">\n                    </button>\n                    <div class="dropdown-content">\n                        <a href="/user/winner_uid">\xf0\x9f\x91\xa4 My Profile</a>\n                        <a href="/auth/change_password">\xf0\x9f\x94\x91 Settings / Change Password</a>\n                        \n                        <div class="dropdown-divider"></div>\n                        <a href="/auth/logout">\xf0\x9f\x9a\xaa Logout</a>\n                    </div>\n                </div>\n                \n                <button class="hamburger-menu">\n                    <span></span>\n                    <span></span>\n                    <span></span>\n                </button>\n            </div>\n        </nav>\n    </div>\n</header>\n    <div class="container">\n        <main class="main-content">\n            \n            \n            \n            <div class="flashes">\n                \n                \n                <div class="alert alert-danger">not enough values to unpack (expected 2, got 0)</div>\n                \n                \n            </div>\n\n            <div class="toast-container">\n                \n                \n                \n            </div>\n            \n            \n            \n<div class="form-container">\n    <h2>Record Match </h2>\n    \n    <form name="record-match-form" method="POST">\n        <input id="group_id" name="group_id" type="hidden" value="">\n<input id="tournament_id" name="tournament_id" type="hidden" value="">\n\n        <div class="form-group">\n            <label for="match_type">Match Type</label>\n            <select class="form-control" id="match_type" name="match_type" onchange="toggleFields()" required><option selected value="singles">Singles</option><option value="doubles">Doubles</option></select>\n        </div>\n\n        <div class="form-group">\n            <label for="player1">Team 1 Player 1</label>\n            <select class="form-control" id="player1" name="player1" required><option selected value="winner_uid">Winner</option><option value="loser_uid">Loser</option></select>\n        </div>\n        <div class="form-group" id="partner-group" style="display: none;">\n            <label for="partner">Partner</label>\n            <select class="form-control" id="partner" name="partner"><option value="winner_uid">Winner</option><option value="loser_uid">Loser</option></select>\n        </div>\n\n        <div class="form-group">\n            <label id="player1-score-label" for="player1_score">Your Score</label>\n            <input class="form-control" id="player1_score" name="player1_score" required type="number" value="11">\n        </div>\n\n        <hr>\n\n        <div class="form-group">\n            <label id="player2-label" for="player2">Opponent</label>\n            <select class="form-control" id="player2" name="player2" required><option value="winner_uid">Winner</option><option selected value="loser_uid">Loser</option></select>\n        </div>\n\n        <div class="form-group" id="opponent2-group" style="display: none;">\n            <label for="opponent2">Opponent 2</label>\n            <select class="form-control" id="opponent2" name="opponent2"><option value="winner_uid">Winner</option><option value="loser_uid">Loser</option></select>\n        </div>\n\n        <div class="form-group">\n            <label id="player2-score-label" for="player2_score">Opponent\'s Score</label>\n            <input class="form-control" id="player2_score" name="player2_score" required type="number" value="5">\n        </div>\n\n        <hr>\n\n        <div class="form-group">\n            <label for="match_date">Date</label>\n            <input class="form-control" id="match_date" name="match_date" required type="date" value="2026-02-10">\n        </div>\n\n        <div id="prediction-preview" style="display: none; margin-bottom: 20px;">\n            \n            <div class="card bg-light mb-3">\n    <div class="card-body p-3">\n        <h6 class="card-title text-center text-muted text-uppercase small mb-3">Match Forecast</h6>\n        \n        <div class="d-flex align-items-center justify-content-between mb-2">\n            <span class="font-weight-bold text-primary">Team 1</span>\n            <span class="font-weight-bold text-danger">Team 2</span>\n        </div>\n\n        <div class="progress" style="height: 10px;">\n            <div class="progress-bar bg-primary" role="progressbar" style="width: 50%" \n                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>\n            <div class="progress-bar bg-danger" role="progressbar" style="width: 50%" \n                 aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>\n        </div>\n        \n        <div class="d-flex justify-content-between mt-1 small text-muted">\n            <span>50% Win Prob</span>\n            <span>50% Win Prob</span>\n        </div>\n\n        <p class="text-center mt-3 mb-0 small text-dark font-italic">\n            "Calculating..."\n        </p>\n    </div>\n</div>\n        </div>\n\n        <button type="submit" class="btn btn-volt">Record Match</button>\n        \n        \n            <a href="/user/dashboard" class="btn btn-danger" style="margin-top: 10px;">Cancel</a>\n        \n    </form>\n\n    <script>\n        document.getElementById(\'match_date\').valueAsDate = new Date();\n\n        function toggleFields() {\n            var matchType = document.getElementById(\'match_type\').value;\n            var partnerGroup = document.getElementById(\'partner-group\');\n            var opponent2Group = document.getElementById(\'opponent2-group\');\n            var predictionPreview = document.getElementById(\'prediction-preview\');\n\n            var player1ScoreLabel = document.getElementById(\'player1-score-label\');\n            var player2Label = document.getElementById(\'player2-label\');\n            var player2ScoreLabel = document.getElementById(\'player2-score-label\');\n\n            if (matchType === \'doubles\') {\n                partnerGroup.style.display = \'block\';\n                opponent2Group.style.display = \'block\';\n                player1ScoreLabel.innerText = \'Team 1 Score\';\n                player2Label.innerText = \'Opponent 1\';\n                player2ScoreLabel.innerText = \'Team 2 Score\';\n            } else {\n                partnerGroup.style.display = \'none\';\n                opponent2Group.style.display = \'none\';\n                player1ScoreLabel.innerText = \'Your Score\';\n                player2Label.innerText = \'Opponent\';\n                player2ScoreLabel.innerText = \'Opponent\\\'s Score\';\n            }\n            \n            // Show prediction preview if players are selected\n            checkPredictionVisibility();\n        }\n\n        // Mutual Exclusivity for Player Dropdowns\n        const playerDropdowns = [\n            document.getElementById(\'player1\'),\n            document.getElementById(\'partner\'),\n            document.getElementById(\'player2\'),\n            document.getElementById(\'opponent2\')\n        ];\n\n        function checkPredictionVisibility() {\n            const p1 = document.getElementById(\'player1\').value;\n            const p2 = document.getElementById(\'player2\').value;\n            const preview = document.getElementById(\'prediction-preview\');\n            \n            // Basic logic: show prediction widget if at least two opponents are selected\n            if (p1 && p2) {\n                preview.style.display = \'block\';\n            } else {\n                preview.style.display = \'none\';\n            }\n        }\n\n        function updateDropdowns() {\n            const selectedValues = playerDropdowns.map(dropdown => dropdown.value).filter(Boolean);\n\n            playerDropdowns.forEach(dropdown => {\n                Array.from(dropdown.options).forEach(option => {\n                    if (selectedValues.includes(option.value) && option.value !== dropdown.value) {\n                        option.disabled = true;\n                    } else {\n                        option.disabled = false;\n                    }\n                });\n            });\n            checkPredictionVisibility();\n        }\n\n        playerDropdowns.forEach(dropdown => {\n            dropdown.addEventListener(\'change\', updateDropdowns);\n        });\n\n        // Initialize state\n        toggleFields();\n        updateDropdowns();\n    </script>\n    <script src="/static/js/optimistic_submission.js"></script>\n</div>\n\n        </main>\n    </div>\n\n    <footer class="footer mt-auto py-3">\n    <div class="container text-center">\n        <span class="text-muted">\n            &copy; 2026 Pick-A-Ladder \n            <span class="mx-2">|</span>\n            v0.9.25\n        </span>\n    </div>\n</footer>\n\n    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>\n    <script>\n        $(document).ready(function () {\n            $(\'.toast\').toast(\'show\');\n        });\n\n        function showToast(message, category = \'info\', submissionId = null) {\n            const toastContainer = document.querySelector(\'.toast-container\');\n            if (!toastContainer) return;\n\n            const toastId = submissionId || `toast_${Date.now()}`;\n            const autohide = category !== \'info\'; // Don\'t autohide pending toasts\n            const delay = 5000;\n\n            let progressBar = \'\';\n            if (category === \'info\') {\n                progressBar = \'<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>\';\n            }\n\n            const toastHTML = `\n                <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" ${autohide ? `data-delay="${delay}" data-autohide="true"` : \'\'}>\n                    <div class="toast-header">\n                        <img src="/static/pickaladder_logo_64.png" class="rounded mr-2" alt="Logo" style="width: 20px; height: 20px;">\n                        <strong class="mr-auto">pickaladder</strong>\n                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n                            <span aria-hidden="true">&times;</span>\n                        </button>\n                    </div>\n                    <div class="toast-body">\n                        ${message}\n                        ${progressBar}\n                    </div>\n                </div>\n            `;\n            toastContainer.insertAdjacentHTML(\'beforeend\', toastHTML);\n            const newToast = document.getElementById(toastId);\n            $(newToast).toast(\'show\');\n            return toastId;\n        }\n\n        function updateToast(toastId, message, category) {\n            const toastElement = document.getElementById(toastId);\n            if (!toastElement) return;\n\n            const toastBody = toastElement.querySelector(\'.toast-body\');\n\n            // Remove progress bar\n            const progressBar = toastBody.querySelector(\'.progress\');\n            if (progressBar) {\n                progressBar.remove();\n            }\n\n            toastBody.innerHTML = message;\n\n            // Add a retry button for failed submissions\n            if (category === \'danger\') {\n                const retryButton = document.createElement(\'button\');\n                retryButton.className = \'btn btn-sm btn-link\';\n                retryButton.innerText = \'Retry\';\n                retryButton.onclick = function () {\n                    window.optimisticSubmission.retrySubmission(toastId);\n                };\n                toastBody.appendChild(document.createElement(\'br\'));\n                toastBody.appendChild(retryButton);\n            }\n\n            $(toastElement).data(\'autohide\', true);\n            $(toastElement).data(\'delay\', 5000);\n\n            // Hack to restart the autohide timer\n            $(toastElement).toast(\'hide\');\n            $(toastElement).toast(\'show\');\n        }\n\n        document.addEventListener("click", (e) => {\n            const row = e.target.closest(".clickable-row");\n            if (row && row.dataset.href && !e.target.closest("a") && !e.target.closest("button") && !e.target.closest("input")) {\n                window.location.href = row.dataset.href;\n            }\n        });\n\n        const hamburger = document.querySelector(\'.hamburger-menu\');\n        if (hamburger) {\n            hamburger.addEventListener(\'click\', function () {\n                document.querySelector(\'.dropdown-content\').classList.toggle(\'active\');\n            });\n        }\n    </script>\n\n    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>\n    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>\n    <script>\n        const firebaseConfig = {\n            apiKey: "dummy-test-key",\n            authDomain: "pickaladder.firebaseapp.com",\n            projectId: "pickaladder",\n            storageBucket: "pickaladder.appspot.com",\n            messagingSenderId: "402457219675",\n            appId: "1:402457219675:web:a346e2dc0dfa732d31e57e",\n            measurementId: "G-E28CXCXTSK"\n        };\n        // Intercept fetch to add the auth token\n        const originalFetch = window.fetch;\n        window.fetch = function (url, options) {\n            const token = localStorage.getItem(\'firebaseIdToken\');\n            if (token) {\n                options = options || {};\n                options.headers = options.headers || {};\n                options.headers[\'Authorization\'] = \'Bearer \' + token;\n            }\n            return originalFetch(url, options);\n        };\n\n        // Initialize Firebase\n        firebase.initializeApp(firebaseConfig);\n    </script>\n\n    \n</body>\n\n</html>'

tests/test_match.py:147: AssertionError
=========================== short test summary info ============================
FAILED tests/test_match.py::MatchRoutesFirebaseTestCase::test_record_match - ...
========================= 1 failed, 2 passed in 1.34s ==========================
